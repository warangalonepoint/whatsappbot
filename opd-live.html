<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OPD · Live</title>

  <!-- Dexie first, then db.js (relative path) -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>
  <script src="./scripts/db.js?v=11"></script>

  <!-- (Optional) QR local first, CDN fallback -->
  <script src="./scripts/qrcode.min.js"></script>
  <script> if(!window.QRCode){const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';document.head.appendChild(s);} </script>

  <style>
    :root{
      --bg-gradient:linear-gradient(145deg,#f4f8f6,#f3f0fa,#fff4ec);
      --mint:#E8F6ED; --lav:#F0EAFE; --peach:#FFF3E8; --blue:#EAF6FF; --pink:#FFF0F6; --lime:#F2FFE9;
      --card:#fff; --ink:#0f172a; --muted:#475569; --primary:#17B26A;
      --r:16px; --shadow:0 6px 18px rgba(0,0,0,.06);
      --banner-h:160px; --banner-fit:contain; --banner-bg:var(--lav);
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui;background:var(--bg-gradient);color:var(--ink)}
    .wrap{max-width:1180px;margin:0 auto;padding:10px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;background:color-mix(in oklab, var(--mint) 60%, white 40%);border-radius:12px;box-shadow:var(--shadow);margin:10px 0}
    .header .logo{height:40px}
    .badge{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-weight:700}
    .badge.ghost{background:#0000}
    .banner{overflow:hidden;border-radius:16px;margin:12px 0;background:var(--banner-bg);
      height:var(--banner-h);display:flex;align-items:center;justify-content:center}
    .banner img{display:block;max-height:calc(var(--banner-h) - 10px);width:100%;object-fit:var(--banner-fit);object-position:center;opacity:.96;mix-blend-mode:multiply;border-radius:var(--r)}
    .layout{display:grid;gap:12px;grid-template-columns:1fr}
    .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .input,select,textarea{border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;width:100%}
    textarea{min-height:88px;resize:vertical}
    .btn{border:1px solid #cbd5e1;border-radius:12px;padding:9px 12px;background:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .small{font-size:12px;color:#64748b}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid #e5e7eb;border-radius:999px;background:#fff;padding:6px 10px;cursor:pointer}
    .chip.on{background:#111827;color:#fff;border-color:#111827}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left}
    .table th{background:#f8fafc}
    .kv{display:grid;gap:8px;grid-template-columns:repeat(6, minmax(120px,1fr))}
    @media (max-width:740px){ .kv{grid-template-columns:repeat(2,1fr)} }
    .qrbox{width:120px;height:120px;border:1px dashed #e5e7eb;border-radius:12px;display:grid;place-items:center;background:#fff}
    .ok{color:#065f46;background:#dcfce7;border-radius:8px;padding:6px 10px;display:inline-block}
    .err{color:#991b1b;background:#fee2e2;border-radius:8px;padding:6px 10px;display:inline-block}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div style="display:flex;align-items:center;gap:10px">
      <a class="btn" href="./index.html">← Home</a>
      <a class="btn" href="./bookings.html">Bookings</a>
      <img class="logo" id="hdrLogo" src="./assets/logo.png" alt="logo"/>
      <div>
        <div style="font-weight:800;font-size:18px">OPD · Live</div>
        <div class="small">PID <b id="hdrPID">—</b> · Token <b id="hdrTok">—</b> · Age <b id="hdrAge">—</b></div>
      </div>
    </div>
    <div class="row" style="gap:8px">
      <button class="btn" id="btnSaveOPD">Save OPD</button>
      <button class="btn" id="btnShareWA">WhatsApp</button>
      <button class="btn" id="btnPrint">Print</button>
    </div>
  </div>

  <div class="banner"><img id="hdrBanner" src="./assets/banner.png" alt="Clinic Banner"></div>

  <div class="layout">
    <div style="display:grid;gap:12px">

      <!-- Load token/patient -->
      <section class="card" style="background:var(--lav)">
        <b>Load Patient / Token</b>
        <div class="row">
          <div style="flex:0 0 140px"><label>PID</label><input id="loadPID" class="input" placeholder="P01/P0001"/></div>
          <div style="flex:0 0 160px"><label>Phone</label><input id="loadPhone" class="input" maxlength="10" inputmode="numeric"/></div>
          <div style="flex:1 1 220px">
            <label>Today’s Tokens (active)</label>
            <div class="row" style="gap:6px">
              <select id="loadTokenSel" class="input" style="flex:1 1 220px"><option value="">— none —</option></select>
              <button class="btn" id="btnUseToken">Use</button>
            </div>
            <div id="nextTokHint" class="small"></div>
          </div>
          <div class="row" style="align-items:end;margin-left:auto;gap:8px">
            <button class="btn" id="btnLoad">Load</button>
            <button class="btn" id="btnClear">Clear</button>
            <div class="qrbox"><div id="qrBox"></div></div>
          </div>
        </div>
        <div id="opdMsg" class="small" style="margin-top:6px"></div>
      </section>

      <!-- Patient / vitals / notes ... (unchanged UI) -->
      <section class="card" style="background:#E8F6ED">
        <div class="row">
          <div style="flex:0 0 120px"><label>PID</label><input id="pid" class="input" readonly/></div>
          <div style="flex:1 1 260px"><label>Patient</label><input id="name" class="input"/></div>
          <div style="flex:0 0 120px"><label>Token</label><input id="token" class="input" readonly/></div>
        </div>
        <div class="row">
          <div style="flex:0 0 160px"><label>Phone</label><input id="phone" class="input"/></div>
          <div style="flex:0 0 180px"><label>DOB</label><input id="dob" type="date" class="input"/></div>
          <div style="flex:0 0 160px"><label>Age</label><input id="age" class="input" readonly/></div>
          <div style="flex:0 0 160px"><label>Gender</label>
            <select id="gender" class="input"><option>Male</option><option>Female</option><option>Other</option></select>
          </div>
          <div style="flex:1 1 220px"><label>Next Visit</label><input id="nextVisit" type="date" class="input"/></div>
          <div style="flex:1 1 220px"><label>Last Visit</label><input id="lastVisit" class="input" readonly/></div>
        </div>
      </section>

      <section class="card" style="background:#FFF3E8">
        <b>Vitals</b>
        <div class="kv">
          <div><label>Height (cm)</label><input id="vHt" class="input" inputmode="decimal"/></div>
          <div><label>Weight (kg)</label><input id="vWt" class="input" inputmode="decimal"/></div>
          <div><label>Temp (°C)</label><input id="vTemp" class="input" inputmode="decimal"/></div>
          <div><label>Pulse</label><input id="vPulse" class="input" inputmode="numeric"/></div>
          <div><label>SpO₂ (%)</label><input id="vSpo2" class="input" inputmode="numeric"/></div>
          <div><label>Growth</label><input id="growthVerdict" class="input" readonly value="—"/></div>
        </div>
      </section>

      <section class="card" style="background:#F2FFE9">
        <b>Recommended Vaccinations (near due)</b>
        <div id="vaxList" class="small">Enter DOB to compute due vaccinations.</div>
      </section>

      <section class="card" style="background:#EAF6FF">
        <b>Chief Complaint</b>
        <div id="ccChips" class="chips" style="margin:6px 0"></div>
        <textarea id="complaints" placeholder="Free text (auto-appends selected chips)…"></textarea>
      </section>

      <section class="card" style="background:#EAF6FF">
        <div class="row">
          <div style="flex:1 1 320px">
            <b>Diagnosis</b>
            <textarea id="diagnosis" placeholder="Provisional / Differential diagnosis…"></textarea>
          </div>
          <div style="flex:1 1 320px">
            <b>Treatment / Plan</b>
            <textarea id="plan" placeholder="Plan, advice, counseling, follow-up…"></textarea>
          </div>
        </div>
      </section>

      <section class="card" style="background:#FFF0F6">
        <div class="row" style="align-items:center">
          <b style="flex:1">Prescription</b>
          <button class="btn" id="btnAddRx">+ Add line</button>
        </div>
        <table class="table" id="rxTbl">
          <thead><tr>
            <th style="width:28%">Drug</th><th style="width:16%">Dose</th><th style="width:16%">Freq</th>
            <th style="width:14%">Days</th><th>Notes</th><th style="width:60px">Del</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card" style="background:#F2FFE9">
        <div class="row" style="align-items:center">
          <b style="flex:1">Lab Orders</b>
          <button class="btn" id="btnAddLab">+ Add test</button>
        </div>
        <table class="table" id="labTbl">
          <thead><tr><th style="width:56%">Test</th><th style="width:28%">Notes</th><th style="width:60px">Del</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

    </div>
    <div style="display:grid;gap:12px"></div>
  </div>
</div>

<script>
/* ===== Helpers (unchanged UI) ===== */
const $=s=>document.querySelector(s);
const todayISO=()=>new Date().toISOString().slice(0,10);
const ageParts=d=>{ if(!d) return {y:0,m:0,d:0,months:0,text:''}; const a=new Date(d), b=new Date(); let y=b.getFullYear()-a.getFullYear(), m=b.getMonth()-a.getMonth(), dd=b.getDate()-a.getDate(); if(dd<0){m--; dd+=new Date(b.getFullYear(),b.getMonth(),0).getDate();} if(m<0){y--; m+=12;} return {y,m,d:dd,months:y*12+m,text:`${y}y ${m}m ${dd}d`}; };
const ageStr=d=>ageParts(d).text;
function toast(t,ok=true){ const el=$('#opdMsg'); if(!el) return; el.className=ok?'ok':'err'; el.textContent=t; el.style.display='inline-block'; setTimeout(()=>{ el.style.display='none'; }, 1600); }

/* ===== Branding ===== */
async function loadBranding(){
  try{ await DB.open?.(); }catch{}
  let b=null; try{ b=(await DB.settings?.get?.('branding'))?.val||null; }catch{}
  if(!b){ try{ b=JSON.parse(localStorage.getItem('branding_json')||'null'); }catch{} }
  document.getElementById('hdrLogo').src   = b?.logoUrl   || './assets/logo.png';
  document.getElementById('hdrBanner').src = b?.bannerUrl || './assets/banner.png';
}

/* ===== DB handle ===== */
const DBH = window.DB;

/* ===== Tokens dropdown (today, active) ===== */
const ACTIVE=new Set(['queued','waiting']);
async function populateTokensDropdown(pidFilter=''){
  const sel=$('#loadTokenSel'); sel.innerHTML='<option value="">— none —</option>';
  const today=todayISO();
  let rows=[]; try{ rows=await DBH.bookings.where('date').equals(today).toArray(); }catch{}
  let list=rows.filter(r=>ACTIVE.has(String(r.status||'').toLowerCase()));
  if(pidFilter){ const up=pidFilter.toUpperCase(); list=list.filter(r=>(r.pid||'').toUpperCase()===up); }
  list.sort((a,b)=>String(a.tokenNo??a.token??'').localeCompare(String(b.tokenNo??b.token??'')) || (a.ts||0)-(b.ts||0));
  for(const r of list){ const tok=r.tokenNo??r.token??''; const o=document.createElement('option'); o.value=String(tok); o.textContent=`#${tok} · ${r.name||r.patientName||''} · ${r.pid||''}`; sel.appendChild(o); }
}

/* ===== Prefill ===== */
async function loadPatientByKeys(pid, phone){
  let p=null; if(pid) p=await DBH.patients.where('pid').equals(pid).first();
  if(!p && phone) p=await DBH.patients.where('phone').equals(phone).first();
  if(!p) return null;
  $('#pid').value=p.pid||''; $('#name').value=p.name||p.patientName||''; $('#phone').value=p.phone||''; $('#dob').value=p.dob||''; $('#age').value=p.dob?ageStr(p.dob):''; $('#gender').value=p.gender||'Male'; return p;
}
$('#btnLoad').onclick=async()=>{ const p=await loadPatientByKeys(($('#loadPID').value||'').trim().toUpperCase(), ($('#loadPhone').value||'').trim()); if(!p){ toast('No patient found',false); return; } populateTokensDropdown($('#pid').value); toast('Loaded'); };
$('#loadPID').addEventListener('input',e=>populateTokensDropdown(e.target.value));
$('#btnUseToken').onclick=async()=>{ const tok=$('#loadTokenSel').value; if(!tok) return; const today=todayISO(); const rows=await DBH.bookings.where('date').equals(today).toArray(); const hit=rows.find(b=>String(b.tokenNo??b.token??'')===String(tok) && ACTIVE.has(String(b.status||'').toLowerCase())); if(!hit) return toast('Token not found',false); $('#pid').value=(hit.pid||'').toUpperCase(); $('#name').value=hit.name||hit.patientName||''; $('#phone').value=hit.phone||''; $('#gender').value=hit.gender||'Male'; $('#dob').value=hit.dob||''; $('#age').value=hit.dob?ageStr(hit.dob):(hit.age||''); $('#token').value=String(hit.tokenNo??hit.token??''); toast(`Loaded token #${tok}`); };

/* ===== Rx/Lab UI helpers ===== */
function addRxRow(d={}){ const tb=$('#rxTbl tbody'); const tr=document.createElement('tr'); tr.innerHTML=`<td><input class="input" value="${d.drug||''}" placeholder="Medicine"/></td><td><input class="input" value="${d.dose||''}" placeholder="5 ml / 1 tab"/></td><td><input class="input" value="${d.freq||''}" placeholder="1-0-1"/></td><td><input class="input" value="${d.days||''}" inputmode="numeric" placeholder="3"/></td><td><input class="input" value="${d.notes||''}" placeholder="after food / SOS"/></td><td><button class="btn" onclick="this.closest('tr').remove()">✕</button></td>`; tb.appendChild(tr); }
function addLabRow(d={}){ const tb=$('#labTbl tbody'); const tr=document.createElement('tr'); tr.innerHTML=`<td><input class="input" value="${d.test||''}" placeholder="CBC / CRP / Dengue…"/></td><td><input class="input" value="${d.notes||''}" placeholder="Fasting / Urgent"/></td><td><button class="btn" onclick="this.closest('tr').remove()">✕</button></td>`; tb.appendChild(tr); }
$('#btnAddRx').onclick=()=>addRxRow();
$('#btnAddLab').onclick=()=>addLabRow();

/* ===== Collect & Save (push queues) ===== */
function collectRx(){ return [...document.querySelectorAll('#rxTbl tbody tr')].map(tr=>{ const t=tr.querySelectorAll('input'); return {drug:t[0].value,dose:t[1].value,freq:t[2].value,days:t[3].value,notes:t[4].value,name:t[0].value, qty:1}; }).filter(r=>r.drug?.trim()); }
function collectLabs(){ return [...document.querySelectorAll('#labTbl tbody tr')].map(tr=>{ const t=tr.querySelectorAll('input'); return {test:t[0].value,notes:t[1].value}; }).filter(r=>r.test?.trim()); }

async function saveOPD(){
  const pid=$('#pid').value.trim(); if(!pid) return toast('No PID loaded', false);
  const rec={
    ts:Date.now(), date:todayISO(), pid,
    name:$('#name').value, phone:$('#phone').value,
    token:$('#token').value||null,
    rx:collectRx(), labs:collectLabs()
  };
  try{ if(rec.rx.length){ await DB.enqueuePharmacyRx({ pid:rec.pid, patientName:rec.name, patientPhone:rec.phone, items:rec.rx }); } }catch{}
  try{ if(rec.labs.length){ await DB.enqueueLabOrder({ pid:rec.pid, name:rec.name, phone:rec.phone, tokenRef:`${rec.pid}-${rec.token||''}`, items:rec.labs, source:'opd' }); } }catch{}
  toast('OPD saved');
  return rec;
}

function clinicName(){ try{ return (JSON.parse(localStorage.getItem('branding_json')||'{}').clinicName) || 'Your Clinic'; }catch{return 'Your Clinic';} }
function buildWA(rec){
  const lines=[`Hello from ${clinicName()}.`,`Consultation summary for ${rec.name} (PID ${rec.pid}).`,`Token #${rec.token||'-'} · Date ${rec.date}.`];
  return encodeURIComponent(lines.join('\n'));
}
document.getElementById('btnSaveOPD').onclick=saveOPD;
document.getElementById('btnShareWA').onclick=async()=>{ const rec=await saveOPD(); if(!rec) return; const ph=(rec.phone||'').replace(/\D/g,''); if(!/^\d{10}$/.test(ph)) return toast('Invalid phone', false); window.open(`https://wa.me/91${ph}?text=${buildWA(rec)}`,'_blank'); };
document.getElementById('btnPrint').onclick=()=>{ const rec={pid:$('#pid').value,name:$('#name').value,phone:$('#phone').value,token:$('#token').value,date:todayISO(),rx:collectRx(), labs:collectLabs()}; try{ localStorage.setItem('opd_print_payload', JSON.stringify(rec)); }catch{} window.open('./print/opd-slip.html?pid='+encodeURIComponent(rec.pid),'_blank'); };

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await DB.ensureOpen();
  await loadBranding();
  populateTokensDropdown('');
  addRxRow(); addLabRow();
});
</script>
</body>
</html>