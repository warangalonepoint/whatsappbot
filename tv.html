<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TV · Live Queue</title>

<!-- App look & colours (locked to the unified pastel theme) -->
<style>
:root{
  --bg-gradient:linear-gradient(145deg,#eef3f1,#f0eef9,#fff2eb);
  --mint:#D6E5DD; --lav:#DED8F2; --peach:#FFE8D9; --teal:#C8F5E4;
  --card:#ffffff; --ink:#0f172a; --muted:#475569; --primary:#139a5b;
  --r:18px; --shadow:0 8px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font:18px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  background:var(--bg-gradient);color:var(--ink);}

.wrap{max-width:1200px;margin:0 auto;padding:10px}
.header{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  background:rgba(214,229,221,.7); /* mint tint */
  border:1px solid #0001;border-radius:12px;margin-top:10px;padding:10px 14px;
  box-shadow:var(--shadow);backdrop-filter:saturate(120%) blur(2px);
}
.header .left{display:flex;align-items:center;gap:10px}
.logo{height:44px}
.hmeta{display:flex;flex-direction:column}
.hmeta strong{font-size:20px}
.hmeta small{font-size:13px;color:var(--muted)}
.actions{display:flex;gap:8px;align-items:center}
.btn{background:#fff;border:1px solid #cbd5e1;border-radius:999px;padding:6px 12px;font-weight:700;cursor:pointer}
.btn:hover{background:#f1f5f9}

.card{background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:12px}
.subtitle{display:flex;justify-content:space-between;align-items:center;gap:10px}
.subtitle h2{margin:0;font-size:22px}
.clock{font-weight:800;letter-spacing:1px}

.grid{display:grid;grid-template-columns:1.4fr 1fr;gap:14px}
@media (max-width:1000px){ .grid{grid-template-columns:1fr} }

.table{width:100%;border-collapse:collapse;font-size:18px}
.table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left}
.table th{background:#f8fafc;position:sticky;top:0;z-index:1}

.badge{display:inline-block;border:1px solid #e2e8f0;border-radius:999px;padding:3px 10px;font-size:14px;font-weight:800}
.s_wait{background:#FFF; color:#111;}
.s_room{background:#C8F5E4; color:#065f46;}    /* In Room */
.s_next{background:#FFE8D9; color:#8a3b00;}    /* Next */
.s_done{background:#E5E7EB; color:#475569;}    /* Completed / Skipped */

.big{font-size:44px;font-weight:900;line-height:1.1}
.callout{background:var(--teal);border:1px solid #0000000d;border-radius:16px;padding:16px;text-align:center}
.footer{text-align:center;color:var(--muted);font-size:13px;margin:18px 0 10px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

/* Rows get subtle lift for visibility on TV */
.rowCard{background:#fff;border-radius:12px;border:1px solid #0000000d;box-shadow:var(--shadow);padding:10px;margin-bottom:8px}
.token{font-weight:900;font-size:22px;width:80px;display:inline-block}
.name{font-size:20px;font-weight:700}
.note{font-size:14px;color:#64748b}
.right{float:right}

/* ===== Mascot (C) ===== */
#mascotWrap{
  position:fixed; right:18px; bottom:18px; z-index:9999; pointer-events:none;
}
#mascot{
  width:120px; height:120px; border-radius:50%;
  background:#111; color:#fff; display:grid; place-items:center;
  font-weight:900; font-size:54px; user-select:none;
  box-shadow:0 10px 24px rgba(0,0,0,.25), inset 0 -6px 0 rgba(255,255,255,.08);
  border:3px solid #fff;
  transform-origin:70% 70%;
}
#mascot.halo::after{
  content:""; position:absolute; inset:-10px; border-radius:50%;
  box-shadow:0 0 0 6px rgba(20,184,166,.18), 0 0 40px rgba(20,184,166,.35);
}

/* core anim helpers */
@keyframes wiggle { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(6deg)} 75%{transform:rotate(-6deg)} }
@keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-16px)} }
@keyframes wave   { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(12deg)} }
@keyframes spin   { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
@keyframes pulse  { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.0)} 50%{box-shadow:0 0 0 18px rgba(16,185,129,.22)} }

.act-wiggle{ animation: wiggle .9s ease-in-out 1; }
.act-bounce{ animation: bounce .8s ease-in-out 1; }
.act-wave{   animation: wave  1.1s ease-in-out 1; }
.act-spin{   animation: spin  .8s linear 1; }
.act-pulse{  animation: pulse 1.5s ease-out 1; }

/* celebrate combo */
.celebrate{ animation: bounce .8s ease-in-out 2, pulse 1.6s ease-out 1; }

/* Mini overlay “card” to show demo status */
.demoPill{
  position:fixed; left:12px; bottom:12px; z-index:9998;
  background:#111; color:#fff; padding:8px 12px; border-radius:999px;
  font-weight:800; font-size:12px; letter-spacing:.4px; opacity:.75;
}
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="header">
    <div class="left">
      <img id="logo" class="logo" src="./assets/logo.png" alt="logo"/>
      <div class="hmeta">
        <strong id="clinicName">Clinic Queue Screen</strong>
        <small id="clinicTag">Please be seated; you will be called shortly</small>
      </div>
    </div>
    <div class="actions">
      <span id="today" class="mono"></span>
      <span id="clock" class="clock mono"></span>
      <button class="btn" id="btnFull">Fullscreen</button>
    </div>
  </div>

  <!-- Banner removed as requested -->

  <!-- Doctor & Queue -->
  <div class="card">
    <div class="subtitle">
      <h2>
        Doctor: <span id="docName">—</span>
        <span class="badge" id="docBadge">OPD</span>
      </h2>
      <div class="badge">Date: <span id="forDate">—</span></div>
    </div>

    <div class="grid" style="margin-top:10px">
      <!-- Left: next & now -->
      <section class="callout">
        <div>Now Serving</div>
        <div class="big" id="nowToken">—</div>
        <div class="note" id="nowName">&nbsp;</div>
        <hr style="border:none;border-top:1px dashed #0f172a22;margin:12px 0">
        <div>Next</div>
        <div class="big" id="nextToken">—</div>
        <div class="note" id="nextName">&nbsp;</div>
      </section>

      <!-- Right: full list -->
      <section>
        <table class="table" id="tbl">
          <thead>
            <tr><th style="width:90px">Token</th><th>Patient</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <div class="footer">© 2025 <strong>Powered by Onestop AI Services</strong> · All Rights Reserved</div>
</div>

<!-- Mascot -->
<div id="mascotWrap"><div id="mascot" class="halo">C</div></div>
<div id="demoPill" class="demoPill" style="display:none">DEMO MODE</div>

<script>
/*
  TV Screen – Single Doctor View with Demo Mode & Mascot
  ------------------------------------------------------
  • bookings.html / opd-live.html should write:
      localStorage.setItem('tv_queue_payload', JSON.stringify({...}));
      localStorage.setItem('tv_queue_ping', Date.now().toString());
  • We listen for 'storage' on 'tv_queue_ping' and re-render.
  • Demo Mode:
      - Enable with ?demo=1 OR localStorage.tv_demo="1"
      - Simulates queue and token changes every 10s
      - Shows "DEMO MODE" pill bottom-left
*/

const $ = s => document.querySelector(s);
const pad2 = n => String(n).padStart(2,'0');

function tickClock(){
  const d=new Date();
  $('#clock').textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  $('#today').textContent = d.toLocaleDateString(undefined, {weekday:'short', day:'2-digit', month:'short', year:'numeric'});
}
setInterval(tickClock, 1000); tickClock();

function classFor(status){
  const s = (status||'').toUpperCase();
  if(s==='IN_ROOM' || s==='INROOM' || s==='ROOM') return 's_room';
  if(s==='NEXT') return 's_next';
  if(s==='DONE' || s==='COMPLETED' || s==='SKIPPED') return 's_done';
  return 's_wait';
}
function human(status){
  const s=(status||'').toUpperCase();
  if(s==='IN_ROOM'||s==='INROOM'||s==='ROOM') return 'In Room';
  if(s==='NEXT') return 'Next';
  if(s==='DONE'||s==='COMPLETED') return 'Completed';
  if(s==='SKIPPED') return 'Skipped';
  return 'Waiting';
}

function applyBranding(){
  // Optional branding from settings or localStorage
  try{
    const ls = JSON.parse(localStorage.getItem('branding_json')||'null')||{};
    if(ls.logoUrl)   $('#logo').src = ls.logoUrl;
    if(ls.clinicName) $('#clinicName').textContent = ls.clinicName;
    if(ls.clinicTag)  $('#clinicTag').textContent  = ls.clinicTag;

    // Theme vars
    const THEMES = {
      pastel: {
        "--bg-gradient":"linear-gradient(145deg,#edf3f0,#ece9f6,#fff0e6)",
        "--card":"#ffffff","--ink":"#0f172a","--muted":"#475569","--primary":"#17B26A",
        "--mint":"#C8E3D2","--lav":"#D7CEF0","--peach":"#FFD8B8"
      },
      glass: {
        "--bg-gradient":"linear-gradient(135deg,#f8fafc,#eef2ff)",
        "--card":"#ffffffcc","--ink":"#0f172a","--muted":"#475569","--primary":"#2563eb",
        "--mint":"#e2e8f0","--lav":"#e9d5ff","--peach":"#ffedd5"
      },
      neo: {
        "--bg-gradient":"linear-gradient(135deg,#f3f4f6,#fafafa)",
        "--card":"#ffffff","--ink":"#111827","--muted":"#6b7280","--primary":"#10b981",
        "--mint":"#d1fae5","--lav":"#ede9fe","--peach":"#ffe4e6"
      },
      iphone: {
        "--bg-gradient":"linear-gradient(180deg,#fdf2f8,#eff6ff)",
        "--card":"#ffffff","--ink":"#0f172a","--muted":"#475569","--primary":"#0ea5e9",
        "--mint":"#e0f2fe","--lav":"#e9d5ff","--peach":"#ffe4e6"
      }
    };
    const theme = THEMES[ls.theme || 'pastel'];
    if(theme){
      Object.entries(theme).forEach(([k,v])=> document.documentElement.style.setProperty(k, v));
    }
  }catch{}
}
applyBranding();

function render(payload){
  if(!payload){ clearUI(); return; }

  // Optional hard lock to a doctor id
  const lock = localStorage.getItem('tv_doctor_lock') || '';
  if(lock && payload.doctorId && payload.doctorId !== lock) {
    return; // ignore other doctors
  }

  // Header section
  $('#docName').textContent = payload.doctorName || payload.doctorId || '—';
  $('#docBadge').textContent = payload.dept || 'OPD';
  $('#forDate').textContent = payload.date || new Date().toISOString().slice(0,10);

  const list = Array.isArray(payload.items)? payload.items.slice(): [];
  // Sort by: IN_ROOM first, NEXT, WAITING, then DONE (token asc within groups)
  const rank = s => ({IN_ROOM:0,NEXT:1,WAITING:2,SKIPPED:8,DONE:9,COMPLETED:9})[(s||'').toUpperCase()] ?? 3;
  list.sort((a,b)=> (rank(a.status)-rank(b.status)) || (Number(a.token||0)-Number(b.token||0)));

  // Now & Next
  const now = list.find(x => String(x.status||'').toUpperCase().includes('ROOM'));
  const nxt = list.find(x => String(x.status||'').toUpperCase()==='NEXT') || list.find(x => String(x.status||'').toUpperCase()==='WAITING');
  const prevNow = $('#nowToken').textContent;

  $('#nowToken').textContent = now ? (now.token ?? '—') : '—';
  $('#nowName').textContent  = now ? (now.name  ?? '') : '';
  $('#nextToken').textContent = nxt ? (nxt.token ?? '—') : '—';
  $('#nextName').textContent  = nxt ? (nxt.name  ?? '') : '';

  // Table
  const tb = $('#tbl tbody'); tb.innerHTML='';
  list.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="token">${r.token??''}</span></td>
      <td><div class="name">${escapeHTML(r.name||'')}</div></td>
      <td><span class="badge ${classFor(r.status)}">${human(r.status)}</span></td>`;
    tb.appendChild(tr);
  });

  // Persist last good payload for reload safety
  try{ localStorage.setItem('tv_queue_last', JSON.stringify(payload)); }catch{}

  // If token changed, celebrate!
  if(now && String(prevNow) !== String(now.token)){
    triggerCelebrate();
  }
}

function clearUI(){
  $('#docName').textContent = '—';
  $('#docBadge').textContent = 'OPD';
  $('#forDate').textContent = '—';
  $('#nowToken').textContent='—';
  $('#nowName').textContent='';
  $('#nextToken').textContent='—';
  $('#nextName').textContent='';
  $('#tbl tbody').innerHTML='';
}

function escapeHTML(s){ return String(s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

function readIncoming(){
  let p = null;
  try{ p = JSON.parse(localStorage.getItem('tv_queue_payload')||'null'); }catch{}
  if(!p){
    try{ p = JSON.parse(localStorage.getItem('tv_queue_last')||'null'); }catch{}
  }
  render(p);
}

// React to pings from booking-status/opd-live
window.addEventListener('storage', (e)=>{
  if(e.key==='tv_queue_ping'){
    readIncoming();
  }
});

// Fullscreen
document.getElementById('btnFull').addEventListener('click', ()=>{
  const el = document.documentElement;
  if(!document.fullscreenElement) el.requestFullscreen?.();
  else document.exitFullscreen?.();
});

// Initial load
document.addEventListener('DOMContentLoaded', ()=>{
  // Show today
  const iso = new Date().toISOString().slice(0,10);
  document.getElementById('forDate').textContent = iso;
  readIncoming();
  setupMascot();
  setupDemoToggleFromURL();
  maybeStartDemo();
});

/* ===================== Mascot (always on, silent comedy) ===================== */
let _rndTimer = null;
function setupMascot(){
  const m = $('#mascot');
  if(!m) return;

  // Do a random action every ~20s
  if(_rndTimer) clearInterval(_rndTimer);
  _rndTimer = setInterval(()=> randomAct(), 20000);

  // First greet
  setTimeout(()=>{ addAct('act-bounce'); }, 800);
}
function addAct(cls, dur=1200){
  const m = $('#mascot'); if(!m) return;
  m.classList.remove('act-wiggle','act-bounce','act-wave','act-spin','act-pulse','celebrate');
  void m.offsetWidth; // reflow to restart animation
  m.classList.add(cls);
  setTimeout(()=> m.classList.remove(cls), dur);
}
function randomAct(){
  const acts = ['act-wiggle','act-bounce','act-wave','act-spin','act-pulse'];
  const pick = acts[Math.floor(Math.random()*acts.length)];
  addAct(pick, pick==='act-pulse' ? 1500 : 1000);
}
function triggerCelebrate(){
  const m = $('#mascot'); if(!m) return;
  m.classList.remove('celebrate'); void m.offsetWidth;
  m.classList.add('celebrate');
  setTimeout(()=> m.classList.remove('celebrate'), 1700);
}

/* ===================== Demo Mode (toggle) ===================== */
function getParam(name){
  const url = new URL(location.href);
  return url.searchParams.get(name);
}
function setupDemoToggleFromURL(){
  const q = getParam('demo');
  if(q==='1'){ localStorage.setItem('tv_demo','1'); }
  if(q==='0'){ localStorage.removeItem('tv_demo'); }
}
function isDemo(){ return localStorage.getItem('tv_demo')==='1'; }

let _demoTick = null;
function maybeStartDemo(){
  const pill = $('#demoPill');
  if(isDemo()){
    pill.style.display='inline-block';
    startDemo();
  }else{
    pill.style.display='none';
    stopDemo();
  }
}
function stopDemo(){
  if(_demoTick) clearInterval(_demoTick);
  _demoTick = null;
}
function startDemo(){
  // Seed fake payload
  let tokenBase = 1;
  let items = Array.from({length:10}).map((_,i)=>({
    token: tokenBase+i,
    name: ['Ravi','Meena','Kiran','Lalith','Asha','John','Bala','Ritu','Naveen','Fatima'][i],
    status: i===0 ? 'IN_ROOM' : (i===1 ? 'NEXT' : 'WAITING')
  }));

  function push(){
    const payload = {
      doctorId: "D001",
      doctorName: "Dr. A. Kumar",
      dept: "General Medicine",
      date: new Date().toISOString().slice(0,10),
      items
    };
    try{
      localStorage.setItem('tv_queue_payload', JSON.stringify(payload));
      localStorage.setItem('tv_queue_ping', Date.now().toString());
    }catch{}
    render(payload);
  }

  // First draw
  push();

  // Every 5s: advance token & celebrate
  if(_demoTick) clearInterval(_demoTick);
  _demoTick = setInterval(()=>{
    // Mark current in-room as done, next becomes in-room, next waiting becomes next, shift list
    const curIdx = items.findIndex(r => String(r.status).toUpperCase().includes('ROOM'));
    if(curIdx>=0){ items[curIdx].status = 'DONE'; }

    const nxtIdx = items.findIndex(r => String(r.status).toUpperCase()==='NEXT');
    if(nxtIdx>=0){ items[nxtIdx].status = 'IN_ROOM'; }

    const waitIdx = items.findIndex(r => String(r.status).toUpperCase()==='WAITING');
    if(waitIdx>=0){ items[waitIdx].status = 'NEXT'; }

    // Add one fresh waiting at the end
    const maxTok = Math.max(...items.map(r=>r.token));
    const newName = 'Guest '+(maxTok+1);
    items.push({ token: maxTok+1, name: newName, status:'WAITING' });

    // Keep list manageable (drop earliest DONE if > 14 rows)
    if(items.length>14){
      const d = items.findIndex(r=>r.status==='DONE');
      if(d>=0) items.splice(d,1);
    }

    push(); // this will also trigger mascot celebrate via render()
  }, 10000);

  // Also keep mascot doing silly stuff independently
  randomAct();
}

// Toggle demo quickly with keyboard: D to flip
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase()==='d'){
    if(isDemo()) localStorage.removeItem('tv_demo');
    else localStorage.setItem('tv_demo','1');
    maybeStartDemo();
  }
});
</script>
</body>
</html>