<!doctype html>
<html lang="en">
<head>
  <script src="./config/config.js"></script>
  <script src="./scripts/db.js"></script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Purchase ¬∑ Pharmacy ¬∑ Clinic PWA</title>
  <link rel="manifest" href="./manifest.json"/>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./config.js"></script>
  <style>
    :root{
      --bg-gradient:linear-gradient(145deg,#eef3f1,#f0eef9,#fff2eb);
      --mint:#D6E5DD;--lav:#DED8F2;--peach:#FFE8D9;--card:#fff;--ink:#0f172a;
      --muted:#475569;--primary:#139a5b;--r:16px;--shadow:0 6px 18px rgba(0,0,0,.08)
    }
    :root{--header-tint:#DED8F2;--header-tint-rgba:222,216,242;--banner-tint:#D6E5DD;--banner-tint-rgba:214,229,221}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui;background:var(--bg-gradient);color:var(--ink);}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:0 10px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(var(--header-tint-rgba),.7);border:1px solid #0001;border-radius:12px;margin-top:10px;box-shadow:var(--shadow);}
    .header .logo{height:40px}
    .btn{background:#fff;border:1px solid #cbd5e1;border-radius:20px;padding:6px 14px;font-weight:600;cursor:pointer}
    .btn:hover{background:#f1f5f9}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .banner{position:relative;overflow:hidden;border-radius:var(--r);margin:10px 0;background:var(--banner-tint)}
    .banner img{width:100%;transform:scale(.65);display:block;border-radius:var(--r);mix-blend-mode:multiply;opacity:.95}
    .banner::after{content:"";position:absolute;inset:0;background:linear-gradient(0deg,rgba(var(--banner-tint-rgba),.3),rgba(var(--banner-tint-rgba),.3))}
    .card{background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .input{border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;width:100%}
    .table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left}
    .table th{background:#f1f5f9}
    .total{font-weight:700;text-align:right}
    .footer{text-align:center;padding:14px 4px;font-size:13px;color:var(--muted);margin:18px 0 14px}
    @media print{
      body{background:#fff;color:#000;margin:0}
      .wrap,.header,.banner,.footer{display:none}
      #printArea{display:block;padding:12mm}
      .a4{width:210mm;min-height:297mm;margin:auto}
      .bill{font:13px/1.45 system-ui;color:#000}
      .bill table{width:100%;border-collapse:collapse}
      .bill th,.bill td{border:1px solid #000;padding:4px}
      .bill h2{margin:0 0 4px}
    }
    #printArea{display:none}
    .help{font-size:12px;color:#64748b}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <img id="hdrLogo" class="logo" src="./assets/logo.png" alt="logo">
    <div>
      <div style="font-weight:700;font-size:18px">Purchases (Distributor GST)</div>
      <div style="font-size:13px;color:var(--muted)">Adds stock to Inventory ¬∑ <b>barcode-ready</b></div>
    </div>
    <div class="row" style="gap:6px">
      <a class="btn" id="phBtn" href="./pharmacy.html">Pharmacy</a>
      <a class="btn" href="./index.html">Home</a>
    </div>
  </div>
  <div class="banner"><img id="hdrBanner" src="./assets/banner.png" alt="Clinic Banner"></div>

  <!-- Filter Report -->
  <div class="card" style="background:#EAF6FF">
    <h3>Filter Report</h3>
    <div class="row" style="align-items:end">
      <div style="flex:0 0 200px">
        <label>Type</label>
        <select id="fType" class="input">
          <option value="purchases">Distributor Purchases</option>
          <option value="sales">Actual Sales</option>
        </select>
      </div>
      <div style="flex:0 0 180px">
        <label>From</label>
        <input id="fFrom" class="input" type="date">
      </div>
      <div style="flex:0 0 180px">
        <label>To</label>
        <input id="fTo" class="input" type="date">
      </div>
      <div style="flex:0 0 160px">
        <button class="btn primary" onclick="showFilterReport()">Show Report</button>
      </div>
      <div style="flex:0 0 160px">
        <button class="btn" onclick="exportFilterCSV()">Export CSV</button>
      </div>
    </div>
    <table class="table" id="filterResult" style="margin-top:10px">
      <thead><tr><th>#</th><th>Date</th><th>ID/Invoice</th><th>Total</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="3" class="total">Total</td><td id="fTotal">‚Çπ0.00</td></tr></tfoot>
    </table>
  </div>

  <!-- Header fields -->
  <div class="card" style="background:var(--mint)">
    <div class="row">
      <div style="flex:1"><label>Distributor</label><input id="vendor" class="input" placeholder="SRI VENKATASAI AGENCIES"></div>
      <div style="flex:1"><label>Invoice No</label><input id="inv" class="input" placeholder="INV1234"></div>
      <div style="flex:0 0 180px"><label>Date</label><input id="pdate" class="input" type="date"></div>
      <div style="flex:0 0 260px;align-self:end" class="row">
        <button class="btn primary" onclick="printBill()">üñ®Ô∏è Print GST Invoice</button>
      </div>
    </div>
    <div class="help" style="margin-top:6px">Tip: Scan a product label to prefill name/batch/exp/mrp/rate (if in stock).</div>
  </div>

  <!-- Add rows -->
  <div class="card" style="background:var(--lav)">
    <h3>Add Product to Purchase</h3>
    <div class="row">
      <div style="flex:1"><input id="pname" class="input" placeholder="Product Name"></div>
      <div style="flex:0 0 90px"><input id="ppack" class="input" placeholder="Pack"></div>
      <div style="flex:0 0 110px"><input id="pbatch" class="input" placeholder="Batch (auto UPPER)"></div>
      <div style="flex:0 0 100px"><input id="pexp" class="input" placeholder="MM/YY"></div>
      <div style="flex:0 0 90px"><input id="phsn" class="input" placeholder="HSN" value="30049099"></div>
      <div style="flex:0 0 90px"><input id="pgst" class="input" placeholder="GST%" type="number" value="12"></div>
      <div style="flex:0 0 90px"><input id="pmrp" class="input" placeholder="MRP" type="number"></div>
      <div style="flex:0 0 90px"><input id="prate" class="input" placeholder="Rate" type="number"></div>
      <div style="flex:0 0 90px"><input id="pqty" class="input" placeholder="Qty" type="number"></div>
      <div style="flex:0 0 260px;align-self:end" class="row">
        <button class="btn primary" onclick="addRow()">Add</button>
        <button class="btn" id="scanPurch" data-scan data-scan-target="#pname">Scan</button>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="background:var(--peach)">
    <table class="table" id="ptable">
      <thead>
        <tr>
          <th>#</th><th>Product</th><th>Pack</th><th>Batch</th><th>EXP</th>
          <th>HSN</th><th>GST%</th><th>Rate</th><th>Qty</th><th>Amount</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="10" class="total">Grand Total</td><td id="gtotal">0.00</td></tr></tfoot>
    </table>
    <div class="row" style="justify-content:flex-end;margin-top:8px;gap:8px">
      <button class="btn" onclick="clearAll()">Clear</button>
    </div>
  </div>

  <div class="footer">¬© 2025 <strong>Powered by Onestop AI Services</strong> ¬∑ All Rights Reserved</div>
</div>

<div id="printArea"></div>

<script>
/* ---------- Branding: read DB.settings('branding') or LS 'branding_json' ---------- */
(async function applyBranding(){
  try{
    let b=null;
    if (window.DB?.open) { await DB.open(); b = await DB.settings?.get?.('branding'); b = b?.val || b?.value; }
    if(!b){ try{ b = JSON.parse(localStorage.getItem('branding_json')||'null'); }catch{} }
    const logo = b?.logoUrl || './assets/logo.png';
    const banner = b?.bannerUrl || './assets/banner.png';
    const pharmName = b?.pharmacyName || 'Pharmacy';
    const L = document.getElementById('hdrLogo');  if(L) L.src = logo;
    const B = document.getElementById('hdrBanner'); if(B) B.src = banner;
    const PB = document.getElementById('phBtn');   if(PB) PB.textContent = pharmName;
  }catch(e){ /* silent branding failure */ }
})();

/* ---------- State ---------- */
let STOCK=[], PURCH=[];
function loadStock(){ try{STOCK=JSON.parse(localStorage.getItem('pharma_stock_json')||'[]')}catch{STOCK=[]} }
loadStock();

/* Normalizers / guards */
function normName(v){ return String(v||'').trim(); }
function normBatch(v){ return String(v||'').trim().toUpperCase(); }
function normExp(v){
  const s=String(v||'').trim();
  const m = s.match(/^(\d{1,2})[\/\-](\d{2})$/);
  if(!m) return '';
  const mm = String(Math.min(12, Math.max(1, +m[1]))).padStart(2,'0');
  return mm + '/' + m[2];
}
function clampGst(n){
  n=+n||0;
  if(n<0) n=0;
  if(n>28) n=28;
  return Math.round(n); // nearest whole slab
}

/* Helpers */
function q(sel){return document.querySelector(sel)}
function v(id){return document.getElementById(id).value}
function s(id,val){document.getElementById(id).value=val}
function eqi(a,b){return String(a||'').toLowerCase()===String(b||'').toLowerCase();}
function money(n){ n=+n||0; return n.toFixed(2); }

/* Add line */
function addRow(){
  const r={
    name: normName(v('pname')),
    pack: normName(v('ppack')),
    batch: normBatch(v('pbatch')),
    exp: normExp(v('pexp')),
    hsn: normName(v('phsn')) || '30049099',
    gst: clampGst(v('pgst')),
    rate: Math.max(0, +v('prate')||0),
    qty: Math.max(0, Math.floor(+v('pqty')||0)),
    mrp: Math.max(0, +v('pmrp')||0)
  };
  if(!r.name || !r.batch || !r.exp || !r.qty){
    alert('Required: Product, Batch, valid EXP (MM/YY), Qty'); return;
  }
  PURCH.push(r);
  updateStock(r);
  render();
  ['pname','ppack','pbatch','pexp','phsn','pgst','pmrp','prate','pqty'].forEach(id=>s(id,''));
}

/* Remove line */
function delRow(ix){
  if(ix<0 || ix>=PURCH.length) return;
  if(!confirm('Remove this item from the purchase?')) return;
  PURCH.splice(ix,1);
  render(); // stock already updated on add; we intentionally do not roll back to keep flow simple
}

/* Barcode helper (prefill from existing stock) */
function fillFromBarcode(code){
  let it = STOCK.find(s=> (s.barcode||`${s.name}|${s.batch}`)===code );
  if(!it && code.includes('|')){
    const [nm,bt]=code.split('|');
    it = STOCK.find(s=>eqi(s.name,nm) && s.batch===bt);
  }
  if(it){
    s('pname',it.name); s('ppack',it.pack||''); s('pbatch',it.batch); s('pexp',it.exp);
    s('pmrp',it.mrp); s('prate',it.rate||it.mrp); s('pqty','1');
  }else{
    s('pname',code); s('pqty','1');
  }
}

/* FEFO-safe stock update (Name+Batch+EXP) */
function updateStock(it){
  const i = STOCK.findIndex(s=>eqi(s.name,it.name) && s.batch===it.batch && s.exp===it.exp);
  if(i>=0){
    STOCK[i].qty = (+STOCK[i].qty||0) + (+it.qty||0);
    STOCK[i].mrp = it.mrp || STOCK[i].mrp;
    STOCK[i].rate= it.rate|| STOCK[i].rate;
    STOCK[i].pack= it.pack|| STOCK[i].pack;
  }else{
    STOCK.push({
      name:it.name, pack:it.pack, batch:it.batch, exp:it.exp,
      qty:it.qty, mrp:it.mrp, rate:it.rate,
      barcode: `${it.name}|${it.batch}`
    });
  }
  persistStock();
}

/* Render table */
function render(){
  const tb=q('#ptable tbody'); tb.innerHTML='';
  let t=0;
  PURCH.forEach((r,i)=>{
    const amt=r.qty*r.rate; t+=amt;
    tb.insertAdjacentHTML('beforeend',
      `<tr>
        <td>${i+1}</td><td>${r.name}</td><td>${r.pack||''}</td><td>${r.batch}</td><td>${r.exp}</td>
        <td>${r.hsn}</td><td>${r.gst}</td><td>${money(r.rate)}</td><td>${r.qty}</td><td>${money(amt)}</td>
        <td><button class="btn" onclick="delRow(${i})">‚úï</button></td>
      </tr>`);
  });
  q('#gtotal').textContent=money(t);
}

/* Print + save */
function printBill(){
  if(!PURCH.length){ alert('Add items first'); return; }
  const vndr= v('vendor') || 'SRI VENKATASAI AGENCIES';
  const inv = v('inv')    || ('INV'+Date.now().toString().slice(-6));
  const date= v('pdate')  || new Date().toISOString().slice(0,10);
  const total= +q('#gtotal').textContent || 0;

  const gstSplit={5:0,12:0,18:0,28:0};
  PURCH.forEach(r=>{ gstSplit[r.gst]=(gstSplit[r.gst]||0)+(r.qty*r.rate); });

  const html=`
  <div class="a4 bill">
    <h2>${vndr}</h2><div>Pharmaceutical Distributor</div>
    <div><b>Invoice No:</b> ${inv} &nbsp; <b>Date:</b> ${date}</div><hr>
    <table>
      <thead><tr><th>#</th><th>Product</th><th>Pack</th><th>Batch</th><th>Exp</th><th>HSN</th><th>GST%</th><th>Rate</th><th>Qty</th><th>Amount</th></tr></thead>
      <tbody>
        ${PURCH.map((r,i)=>`<tr>
          <td>${i+1}</td><td>${r.name}</td><td>${r.pack||''}</td><td>${r.batch}</td><td>${r.exp}</td>
          <td>${r.hsn}</td><td>${r.gst}</td><td>${money(r.rate)}</td><td>${r.qty}</td><td>${money(r.qty*r.rate)}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    <div style="text-align:right;margin-top:6px"><b>Total:</b> ${money(total)}</div>
    <div><b>GST Breakup (value basis):</b>
      5% ‚Çπ${money(gstSplit[5])} &nbsp; 12% ‚Çπ${money(gstSplit[12])} &nbsp;
      18% ‚Çπ${money(gstSplit[18])} &nbsp; 28% ‚Çπ${money(gstSplit[28])}
    </div>
    <hr>
    <div style="text-align:center;font-size:12px">
      Bank: UNION BANK OF INDIA ¬∑ A/C 191215140000006 ¬∑ IFSC: UBIN0819123
    </div>
    <div style="text-align:center;font-size:11px">Powered by Onestop AI Services ¬∑ ¬© 2025 ¬∑ All Rights Reserved</div>
  </div>`;
  q('#printArea').innerHTML=html;
  window.print();

  savePurchase({vendor:vndr,inv,date,total,items:PURCH});
  clearAll();
}

/* Persist purchase summary */
function savePurchase(bill){
  let arr=[]; try{arr=JSON.parse(localStorage.getItem('pharma_purchases_json')||'[]')}catch{}
  arr.push(bill);
  localStorage.setItem('pharma_purchases_json',JSON.stringify(arr));

  const month=new Date().toISOString().slice(0,7);
  const count=arr.filter(b=>String(b.date||'').startsWith(month)).length;
  localStorage.setItem('pharma_purchases_month',count);
  try{ localStorage.setItem('stock_touch', String(Date.now())); }catch{}
}

/* Stock persistence */
function persistStock(){ localStorage.setItem('pharma_stock_json',JSON.stringify(STOCK)); }
function clearAll(){ PURCH=[]; render(); }

/* ===== Filter logic (reads existing localStorage data) ===== */
let FILTER_LAST = { type:'', rows:[], from:'', to:'' };

function showFilterReport(){
  const type = document.getElementById('fType').value;
  const fromStr = document.getElementById('fFrom').value || '1970-01-01';
  const toStr   = document.getElementById('fTo').value   || new Date().toISOString().slice(0,10);
  const from = new Date(fromStr);
  const to   = new Date(toStr); to.setHours(23,59,59,999);

  let arr=[];
  if(type==='purchases'){
    try{arr=JSON.parse(localStorage.getItem('pharma_purchases_json')||'[]')}catch{}
  } else {
    try{arr=JSON.parse(localStorage.getItem('pharma_sales_json')||'[]')}catch{}
  }

  const rows=arr.filter(r=>{
    const d=new Date(r.date||r.ts||'');
    return d>=from && d<=to;
  });

  const tb=document.querySelector('#filterResult tbody'); tb.innerHTML='';
  let total=0;
  rows.forEach((r,i)=>{
    const dt=(r.date? r.date.slice(0,10): new Date(r.ts).toISOString().slice(0,10));
    const id=r.inv||r.id||'-';
    const val=Number(r.total||r.amount||0);
    total+=val;
    tb.insertAdjacentHTML('beforeend',`<tr><td>${i+1}</td><td>${dt}</td><td>${id}</td><td>‚Çπ${val.toFixed(2)}</td></tr>`);
  });
  document.getElementById('fTotal').textContent='‚Çπ'+total.toFixed(2);

  FILTER_LAST = {
    type, from: fromStr, to: toStr,
    rows: rows.map(r=>({
      date: (r.date? r.date.slice(0,10): new Date(r.ts).toISOString().slice(0,10)),
      id: r.inv||r.id||'-',
      total: Number(r.total||r.amount||0)
    }))
  };
}

function exportFilterCSV(){
  if(!FILTER_LAST.rows.length){
    alert('Run "Show Report" first.');
    return;
  }
  const lines = ['Date,ID/Invoice,Total'];
  FILTER_LAST.rows.forEach(r=>{
    lines.push(`${r.date},${String(r.id).replace(/,/g,' ')},${r.total.toFixed(2)}`);
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  const safeType = FILTER_LAST.type==='purchases' ? 'purchases' : 'sales';
  const range = `${FILTER_LAST.from}_to_${FILTER_LAST.to}`;
  a.href = URL.createObjectURL(blob);
  a.download = `${safeType}_report_${range}.csv`;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}
</script>

<!-- Engines + Wiring -->
<script src="/scripts/qrcode.min.js?v=1.1"></script>
<script src="/scripts/barcode.js?v=8.4.6"></script>
<script src="/scripts/app-wiring.js?v=1.1"></script>
<script src="/scripts/seed-and-diagnostics.js?v=1.3"></script>

<!-- Pass1 theme + branding hook (non-invasive) -->
<script>
(function(){
  function readBrand(){
    try { return JSON.parse(localStorage.getItem('branding_json')||'null') || null; } catch(e){ return null; }
  }
  const b = readBrand(); if(!b) return;
  const root = document.documentElement;
  const THEMES = {
    pastel: {
      "--bg-gradient":"linear-gradient(145deg,#edf3f0,#ece9f6,#fff0e6)",
      "--card":"#ffffff","--ink":"#0f172a","--muted":"#475569","--primary":"#17B26A",
      "--mint":"#C8E3D2","--lav":"#D7CEF0","--peach":"#FFD8B8"
    },
    glass: {
      "--bg-gradient":"linear-gradient(135deg,#f8fafc,#eef2ff)",
      "--card":"#ffffffcc","--ink":"#0f172a","--muted":"#475569","--primary":"#2563eb",
      "--mint":"#e2e8f0","--lav":"#e9d5ff","--peach":"#ffedd5"
    },
    neo: {
      "--bg-gradient":"linear-gradient(135deg,#f3f4f6,#fafafa)",
      "--card":"#ffffff","--ink":"#111827","--muted":"#6b7280","--primary":"#10b981",
      "--mint":"#d1fae5","--lav":"#ede9fe","--peach":"#ffe4e6"
    },
    iphone: {
      "--bg-gradient":"linear-gradient(180deg,#fdf2f8,#eff6ff)",
      "--card":"#ffffff","--ink":"#0f172a","--muted":"#475569","--primary":"#0ea5e9",
      "--mint":"#e0f2fe","--lav":"#e9d5ff","--peach":"#ffe4e6"
    }
  };
  const theme = THEMES[b.theme || 'pastel'];
  if(theme){
    Object.entries(theme).forEach(([k,v])=> root.style.setProperty(k, v));
  }
  // Swap logos and banners wherever present
  const logoUrl = b.logoUrl || "";
  const banUrl  = b.bannerUrl || "";
  if(logoUrl){
    document.querySelectorAll('img#logo, img#ph_logo, img.logo').forEach(el=> el.src = logoUrl);
  }
  if(banUrl){
    document.querySelectorAll('#hdrBanner, .banner img, img[alt*="Banner"]').forEach(el=> el.src = banUrl);
  }
  // Titles
  if(b.clinicName) { const el=document.getElementById('clinicTitle'); if(el) el.textContent=b.clinicName; }
  if(b.pharmacyName){ const el=document.getElementById('ph_name'); if(el) el.textContent=b.pharmacyName; }
})();
</script>
</body>
</html>