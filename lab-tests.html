<!doctype html>
<html lang="en">
<head>
  <script src="./config/config.js"></script>
  <script src="./scripts/db.js"></script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lab Tests · Parameter Entry</title>
  <link rel="manifest" href="./manifest.json"/>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    :root{
      /* v7.8 darkened pastel baseline (desktop-first) */
      --bg:linear-gradient(145deg,#edf3f0,#ece9f6,#fff0e6);
      --card:#fff; --ink:#0f172a; --muted:#475569; --primary:#17B26A;
      --r:16px; --shadow:0 6px 18px rgba(0,0,0,.06);
      --mint:#E8F6ED; --lav:#EDE7FD; --peach:#FFE9D6;

      /* branding knobs */
      --banner-h: 150px;
      --banner-fit: contain;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui;background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1140px;margin:0 auto;padding:0 10px 18px}

    /* Header */
    .header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#DED8F2cc;border-radius:12px;box-shadow:var(--shadow);margin-top:10px;border:1px solid #e5e7eb}
    .header .logo{height:40px}
    .header .title{font-weight:800;font-size:18px}
    .header .sub{font-size:12px;color:var(--muted)}
    .btn{background:#fff;border:1px solid #cbd5e1;border-radius:20px;padding:6px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border:none}

    /* Banner */
    .banner{position:relative;overflow:hidden;border-radius:16px;margin:12px 0;background:#D6E5DD;border:1px solid #e5e7eb;height:var(--banner-h);display:flex;align-items:center;justify-content:center}
    .banner img{width:100%;max-height:calc(var(--banner-h) - 6px);object-fit:var(--banner-fit);transform-origin:center;opacity:.95;mix-blend-mode:multiply;display:block}

    /* Cards & form */
    .card{background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:12px;border:1px solid #e5e7eb}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .input,select{border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;width:100%;background:#fff}
    .small{font-size:12px;color:#64748b}
    .badge{display:inline-block;border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
    .pill{border:1px solid #e5e7eb;background:#F8FAFC;border-radius:999px;padding:4px 8px;font-size:12px}
    .nowrap{white-space:nowrap}

    /* Table / groups */
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left;vertical-align:top}
    .table th{background:#f1f5f9}
    .group{background:#f8fafc;border:1px solid #e5e7eb;padding:8px;border-radius:10px;margin-top:8px}

    /* Parameters grid */
    .param{display:grid;grid-template-columns:22px 1fr 220px 1fr;gap:10px;align-items:center;margin:8px 0}
    .param .lab{font-weight:600}

    /* Sticky bar */
    .stickbar{position:sticky;bottom:10px;display:flex;gap:8px;justify-content:flex-end;background:transparent}

    /* Editable */
    .editable{border:1px dashed transparent;border-radius:6px;padding:2px 6px;background:#fff;min-height:28px;display:inline-block}
    .editable:focus{outline:2px solid #a7f3d0;border-color:#99f6e4}

    .footer{text-align:center;padding:14px 4px;font-size:13px;color:#64748b;margin:18px 0}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="header">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="hdrLogo" class="logo" src="./assets/logo.png" alt="logo">
      <div>
        <div class="title">Lab Tests · Parameter Entry</div>
        <div class="sub">OPD auto-feed · Tick parameters · Enter results · Save / Print</div>
      </div>
    </div>
    <a class="btn" href="./lab-hub.html">Back</a>
  </div>

  <!-- Banner -->
  <div class="banner"><img id="hdrBanner" src="./assets/banner.png" alt="Clinic Banner"></div>

  <!-- Patient block -->
  <div class="card" style="background:var(--mint)">
    <div class="row">
      <div style="flex:1 1 260px"><label>Patient Name</label><input id="pname" class="input" placeholder="Patient"></div>
      <div style="flex:0 0 140px"><label>PID</label><input id="ppid" class="input" placeholder="P0001"></div>
      <div style="flex:0 0 140px"><label>Sex</label>
        <select id="psex" class="input"><option value="">—</option><option>Male</option><option>Female</option><option>Other</option></select>
      </div>
      <div style="flex:0 0 120px"><label>Age (Y)</label><input id="page" class="input" type="number" min="0" inputmode="numeric"></div>
      <div style="flex:1 1 240px"><label>Ref By</label><input id="pref" class="input" placeholder="Doctor / Self"></div>
      <div style="flex:0 0 160px"><label>Date</label><input id="pdate" class="input" type="date"></div>
    </div>

    <!-- OPD auto-feed controls -->
    <div class="row" style="margin-top:8px;align-items:center;justify-content:space-between">
      <div class="row">
        <div class="badge" id="qinfo">OPD Orders: 0 pending</div>
        <button class="btn" id="btnLoadNext">Load Next OPD Order</button>
      </div>
      <div class="row">
        <div class="badge nowrap" id="totalBadge"><b>Total:</b> ₹ 0</div>
        <button class="btn" id="btnCSV">Export CSV</button>
      </div>
    </div>
  </div>

  <!-- Parameters -->
  <div class="card" style="background:var(--lav)">
    <div class="row" style="align-items:end">
      <div style="flex:1 1 420px">
        <label>Find / Select Test</label>
        <div class="row">
          <select id="testSel" class="input" style="flex:1"></select>
          <input id="tSearch" class="input" placeholder="Quick search…" style="flex:1" autofocus>
        </div>
      </div>
      <div class="badge nowrap" id="priceBadge">₹ 0</div>
      <div class="badge nowrap" id="pcount">0 params</div>
      <button class="btn primary" id="btnAdd">Add to Report</button>
    </div>

    <div id="paramBox" style="margin-top:10px"></div>

    <div class="stickbar" style="margin-top:10px">
      <button class="btn" id="btnClear">Clear</button>
      <button class="btn" id="btnSave">Save Record</button>
      <button class="btn primary" id="btnPrint">Print</button>
    </div>
    <div class="small" style="margin-top:6px;color:#64748b">
      Shortcuts: <span class="pill">Enter</span> next cell · <span class="pill">Esc</span> focus search · <span class="pill">Ctrl+S</span> save · <span class="pill">Ctrl+P</span> print · <span class="pill">Ctrl+N</span> new
    </div>
  </div>

  <!-- Report preview (grouped by test) -->
  <div class="card" style="background:var(--peach)">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Report Preview</h3>
      <div class="small" style="color:#64748b">Click a test header’s ✖ to remove that test; results are editable inline.</div>
    </div>
    <div id="previewWrap"></div>
  </div>

  <div class="footer">© 2025 <strong>Powered by Onestop AI Services</strong> · All Rights Reserved</div>
</div>

<script>
/* ===================== Branding (same model as other pages) ===================== */
function applyBranding(b){
  try{
    document.getElementById('hdrLogo').src   = b?.logoUrl   || './assets/logo.png';
    document.getElementById('hdrBanner').src = b?.bannerUrl || './assets/banner.png';
    document.documentElement.style.setProperty('--banner-h',  `${Number(b?.bannerH||150)}px`);
    document.documentElement.style.setProperty('--banner-fit', b?.bannerFit||'contain');
  }catch{}
}
function lsBrand(){ try{return JSON.parse(localStorage.getItem('branding_json')||'null')||null;}catch{return null;} }
(async function initBrand(){
  try{ await window.DB?.open?.(); }catch{}
  let b=null; try{ b=(await window.DB?.settings?.get?.('branding'))?.val||null; }catch{}
  if(!b) b=lsBrand();
  applyBranding(b||{});
})();
window.addEventListener('storage', e=>{ if(e.key==='branding_touch') initBrand(); });

/* ===================== Tests → Params ===================== */
const TEST_PARAMS = {
  "CBP":[
    {k:"hb",lab:"Hemoglobin",norm:"12 – 18 g/dL",unit:"g/dL"},
    {k:"rbc",lab:"Erythrocytes",norm:"4.2 – 5.2 M/µL"},
    {k:"wbc",lab:"WBC TC",norm:"4,500 – 11,000 /µL"},
    {k:"pcv",lab:"PCV",norm:"37 – 47 %"},
    {k:"plt",lab:"Platelet Count",norm:"1.5 – 4.5 Lakhs/µL"},
    {k:"neu",lab:"Neutrophils",norm:"45 – 70 %"},
    {k:"lym",lab:"Lymphocytes",norm:"20 – 40 %"},
    {k:"eos",lab:"Eosinophil",norm:"02 – 10 %"},
    {k:"mon",lab:"Monocytes",norm:"0 – 6 %"},
    {k:"bas",lab:"Basophile",norm:"0 – 1 %"},
    {k:"esr",lab:"ESR",norm:"0 – 10 mm/hr"}
  ],
  "CRP":[{k:"crp",lab:"CRP",norm:"< 6 mg/L",unit:"mg/L"}],
  "TYPHOID IgM IgG":[
    {k:"ty_igm",lab:"Typhoid IgM",norm:"Negative"},
    {k:"ty_igg",lab:"Typhoid IgG",norm:"Negative"}
  ],
  "CUE":[
    {k:"ur_sp",lab:"Specific Gravity",norm:"1.005 – 1.030"},
    {k:"ur_ph",lab:"pH",norm:"4.6 – 8.0"},
    {k:"ur_prot",lab:"Protein",norm:"Negative"},
    {k:"ur_sug",lab:"Sugar",norm:"Negative"},
    {k:"ur_ket",lab:"Ketone",norm:"Negative"},
    {k:"ur_bld",lab:"Blood",norm:"Negative"},
    {k:"ur_wbc",lab:"Pus Cells",norm:"0 – 5 /HPF"},
    {k:"ur_rbc",lab:"RBC",norm:"0 – 2 /HPF"}
  ],
  "RBS":[{k:"rbs",lab:"Random Blood Sugar",norm:"< 140 mg/dL",unit:"mg/dL"}],
  "TSB":[{k:"tsb",lab:"Total Bilirubin",norm:"0.3 – 1.2 mg/dL"}],
  "DENGUE IgM IgG":[
    {k:"den_igm",lab:"Dengue IgM",norm:"Negative"},
    {k:"den_igg",lab:"Dengue IgG",norm:"Negative"},
    {k:"ns1",lab:"NS1 Antigen",norm:"Negative"}
  ],
  "MALARIA FOR Pv Pf":[
    {k:"mal_pf",lab:"Malaria Pf",norm:"Negative"},
    {k:"mal_pv",lab:"Malaria Pv",norm:"Negative"}
  ],
  "T3, T4, TSH":[
    {k:"t3",lab:"T3",norm:"0.8 – 2.0 ng/mL"},
    {k:"t4",lab:"T4",norm:"5.1 – 14.1 µg/dL"},
    {k:"tsh",lab:"TSH",norm:"0.4 – 4.0 µIU/mL"}
  ],
  "URINE C/S AUTOMATED":[{k:"cs_auto",lab:"Culture & Sensitivity (Automated)",norm:"No growth / Sensitive"}],
  "URINE C/S CONVENTION":[{k:"cs_conv",lab:"Culture & Sensitivity (Conventional)",norm:"No growth / Sensitive"}],
  "LFT":[
    {k:"tbil",lab:"Total Bilirubin",norm:"0.3 – 1.2 mg/dL"},
    {k:"dbil",lab:"Direct Bilirubin",norm:"0.0 – 0.3 mg/dL"},
    {k:"sgot",lab:"SGOT (AST)",norm:"< 40 U/L"},
    {k:"sgpt",lab:"SGPT (ALT)",norm:"< 40 U/L"},
    {k:"alp",lab:"Alkaline Phosphatase",norm:"44 – 147 U/L"},
    {k:"tp",lab:"Total Protein",norm:"6.0 – 8.3 g/dL"},
    {k:"alb",lab:"Albumin",norm:"3.5 – 5.0 g/dL"}
  ],
  "CREATININE":[{k:"crt",lab:"Serum Creatinine",norm:"0.7 – 1.3 mg/dL"}],
  "HBA1C":[{k:"hba1c",lab:"HbA1c",norm:"4.0 – 5.6 %"}],
  "LIPID PROFILE":[
    {k:"chol",lab:"Total Cholesterol",norm:"< 200 mg/dL"},
    {k:"hdl",lab:"HDL",norm:">= 40 mg/dL"},
    {k:"ldl",lab:"LDL",norm:"< 100 mg/dL"},
    {k:"tg",lab:"Triglycerides",norm:"< 150 mg/dL"}
  ],
  "SERUM ELECTROLYTES":[
    {k:"na",lab:"Sodium (Na+)",norm:"135 – 145 mmol/L"},
    {k:"k", lab:"Potassium (K+)",norm:"3.5 – 5.1 mmol/L"},
    {k:"cl",lab:"Chloride (Cl-)",norm:"98 – 106 mmol/L"}
  ],
  "BLOOD GROUPING":[{k:"bg",lab:"Blood Group",norm:"—"}]
};

/* ===== Prices: from lab catalog (lab_tests_json) with fallbacks ===== */
function loadCatalog(){
  let arr=[]; try{arr=JSON.parse(localStorage.getItem('lab_tests_json')||'[]');}catch{}
  if(!Array.isArray(arr)) arr=[];
  const map=new Map(arr.map(x=>[String(x.name||'').trim().toUpperCase(), +x.price||0]));
  [
    ['CBP',300],['CRP',400],['TYPHOID IgM IgG',300],['CUE',150],['RBS',50],['TSB',300],
    ['DENGUE IgM IgG',800],['MALARIA FOR Pv Pf',800],['T3, T4, TSH',500],
    ['URINE C/S AUTOMATED',1100],['URINE C/S CONVENTION',700],['LFT',250],['CREATININE',150],
    ['HBA1C',550],['LIPID PROFILE',550],['SERUM ELECTROLYTES',100],['BLOOD GROUPING',100]
  ].forEach(([n,p])=>{ if(!map.has(n)) map.set(n,p); });
  return map;
}
let PRICE_MAP = loadCatalog();
const priceOf = t => PRICE_MAP.get(String(t||'').toUpperCase())||0;

/* ===== Populate & search tests ===== */
const testSel = document.getElementById('testSel');
const tSearch = document.getElementById('tSearch');
function fillTests(filter=''){
  testSel.innerHTML='';
  Object.keys(TEST_PARAMS)
    .filter(n=> !filter || n.toLowerCase().includes(filter.toLowerCase()))
    .sort()
    .forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; testSel.appendChild(o); });
  if(testSel.options.length){ testSel.value = testSel.options[0].value; renderParams(); }
  else { document.getElementById('paramBox').innerHTML=''; document.getElementById('pcount').textContent='0 params'; document.getElementById('priceBadge').textContent='₹ 0'; }
}
fillTests();
tSearch.addEventListener('input', e=> fillTests(e.target.value));

/* ===== Render parameter rows + price badge ===== */
const paramBox = document.getElementById('paramBox');
const priceBadge = document.getElementById('priceBadge');
function renderParams(){
  paramBox.innerHTML='';
  const list = TEST_PARAMS[testSel.value]||[];
  list.forEach(p=>{
    const wrap=document.createElement('div'); wrap.className='param';
    wrap.innerHTML = `
      <input type="checkbox" data-k="${p.k}" checked>
      <div class="lab">${p.lab}</div>
      <input class="input" type="text" placeholder="Result ${p.unit?('('+p.unit+')'):''}" data-inp="${p.k}">
      <div class="small" data-norm="${p.k}">${p.norm||''}</div>
    `;
    paramBox.appendChild(wrap);
  });
  document.getElementById('pcount').textContent = list.length+' params';
  priceBadge.textContent = '₹ '+ priceOf(testSel.value);
}
testSel.addEventListener('change', renderParams);

/* ===== Preview buffer (grouped) ===== */
let PREVIEW=[];  // rows: {test, key, lab, result, norm}
const previewWrap = document.getElementById('previewWrap');

function groupByTest(rows){
  const map={}; rows.forEach(r=>{ (map[r.test]=map[r.test]||[]).push(r); });
  return map;
}
function redrawPreview(){
  previewWrap.innerHTML='';
  const gp = groupByTest(PREVIEW);
  Object.keys(gp).sort().forEach(test=>{
    const box=document.createElement('div'); box.className='group';
    const price = priceOf(test);
    box.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><b>${test}</b> <span class="pill" style="color:#334155">₹ ${price}</span></div>
        <div class="row">
          <button class="btn" onclick="removeTest('${test.replace(/'/g,"&#39;")}')">✖ Remove Test</button>
        </div>
      </div>
      <table class="table" style="margin-top:6px">
        <thead><tr><th style="width:38%">Parameter</th><th style="width:28%">Result</th><th>Normal Value</th><th style="width:90px">Action</th></tr></thead>
        <tbody></tbody>
      </table>
    `;
    const tb = box.querySelector('tbody');
    gp[test].forEach((r)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.lab}</td>
        <td><span class="editable" contenteditable="true" data-key="${r.key}" onkeydown="nextOnEnter(event)">${r.result||''}</span></td>
        <td class="small">${r.norm||''}</td>
        <td><button class="btn" onclick="delRow('${r.test.replace(/'/g,"&#39;")}','${r.key}')">Delete</button></td>
      `;
      tb.appendChild(tr);
    });
    previewWrap.appendChild(box);
  });
  updateTotalBadge();
}
function selectedTests(){ return [...new Set(PREVIEW.map(x=>x.test))]; }
function totalAmount(){ return selectedTests().reduce((s,t)=>s+priceOf(t),0); }
function updateTotalBadge(){ document.getElementById('totalBadge').textContent = 'Total: ₹ '+ totalAmount(); }

window.delRow = (test,key)=>{
  const i = PREVIEW.findIndex(r=> r.test===test && r.key===key);
  if(i>=0){ PREVIEW.splice(i,1); redrawPreview(); }
};
window.removeTest = (test)=>{
  PREVIEW = PREVIEW.filter(r=> r.test!==test);
  redrawPreview();
};

/* inline edit persist */
document.addEventListener('blur', e=>{
  if(e.target.matches('.editable')){
    const key = e.target.dataset.key;
    const row = PREVIEW.find(r=> r.key===key);
    if(row){ row.result = e.target.textContent.trim(); }
  }
}, true);
window.nextOnEnter = (ev)=>{
  if(ev.key==='Enter'){ ev.preventDefault();
    const edits = Array.from(document.querySelectorAll('.editable'));
    const idx = edits.indexOf(ev.target);
    const next = edits[idx+1]; if(next){ next.focus(); document.getSelection()?.selectAllChildren(next); }
  }
};

/* ===== Add parameters from current test ===== */
function addSelectedToPreview(){
  const tn = testSel.value;
  const list = TEST_PARAMS[tn]||[];
  const added=[];
  list.forEach(p=>{
    const cb=paramBox.querySelector(`input[type=checkbox][data-k="${p.k}"]`);
    const inp=paramBox.querySelector(`input[data-inp="${p.k}"]`);
    if(cb && cb.checked){
      const key = `${tn}|${p.k}|${Date.now()}|${Math.random().toString(36).slice(2,7)}`;
      PREVIEW.push({ test:tn, key, lab:p.lab, result:(inp?.value||'').trim(), norm:p.norm||'' });
      added.push(p.lab);
    }
  });
  redrawPreview();
  return added.length;
}

/* Buttons */
document.getElementById('btnAdd').onclick=()=>{ const n=addSelectedToPreview(); if(n) alert(`Added ${n} line(s) to report`); };
document.getElementById('btnClear').onclick=()=>{ PREVIEW=[]; redrawPreview(); };

/* ===== Helpers ===== */
const todayISO = ()=> new Date().toISOString().slice(0,10);
const val = id => (document.getElementById(id)?.value)||'';
function toInt(x, d=0){ const n=parseInt(x,10); return Number.isFinite(n)?n:d; }

function buildPayload(){
  const date = val('pdate') || todayISO();
  const tests = selectedTests().map(t=>({name:t, price:priceOf(t)}));
  return {
    id: 'LAB'+Date.now(),
    name: val('pname').trim() || '',
    pid: val('ppid').trim() || '',
    sex: val('psex') || '',
    age: toInt(val('page'), ''),
    ref: val('pref').trim() || '',
    date,
    tests,
    total: tests.reduce((s,x)=>s+(+x.price||0),0),
    items: PREVIEW.slice()
  };
}
function ensurePreview(){ return PREVIEW.length>0 || (addSelectedToPreview(), PREVIEW.length>0); }

/* ===== PRINT ===== */
document.getElementById('btnPrint').onclick = async ()=>{
  if(!ensurePreview()){ alert('No items to print'); return; }
  const data = buildPayload();
  try{ localStorage.setItem('last_lab_report', JSON.stringify(data)); }catch{}
  const qs='?data='+encodeURIComponent(JSON.stringify(data))+'&print=1';
  const target='./print/print-lab.html';
  try{
    const r=await fetch(target,{method:'HEAD',cache:'no-store'});
    if(r.ok){ window.open(target+qs,'_blank'); return; }
  }catch{}
  window.print(); // fallback
};

/* ===== SAVE ===== */
document.getElementById('btnSave').onclick = ()=>{
  if(!ensurePreview()){ alert('No items to save'); return; }
  const data = buildPayload();
  let arr=[]; try{ arr=JSON.parse(localStorage.getItem('lab_records_json')||'[]'); }catch{}
  if(!Array.isArray(arr)) arr=[];
  arr.push(data);
  localStorage.setItem('lab_records_json', JSON.stringify(arr));
  alert('✅ Saved to Lab Records');
  window.location.href='./lab-records.html';
};

/* ===== CSV Export of current report ===== */
document.getElementById('btnCSV').onclick = ()=>{
  if(!ensurePreview()){ alert('Nothing to export'); return; }
  const data = buildPayload();
  const rows = [
    ['Report ID', data.id],
    ['Date', data.date],
    ['Patient', data.name],
    ['PID', data.pid],
    ['Sex', data.sex],
    ['Age', data.age],
    ['Ref By', data.ref],
    [],
    ['Test', 'Parameter', 'Result', 'Normal']
  ];
  PREVIEW.forEach(r=> rows.push([r.test, r.lab, r.result||'', r.norm||'']));
  rows.push([]); rows.push(['Total (₹)', String(data.total)]);
  const csv = rows.map(r=> r.map(c=>{
    const s=String(c??'').replace(/"/g,'""');
    return /[",\n]/.test(s)?`"${s}"`:s;
  }).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lab_report_${data.id}.csv`; a.click(); URL.revokeObjectURL(a.href);
};

/* ===== OPD auto-feed (shared queue) ===== */
const QKEY='lab_orders_queue';
function loadQueue(){ let arr=[]; try{arr=JSON.parse(localStorage.getItem(QKEY)||'[]');}catch{} return Array.isArray(arr)?arr:[]; }
function saveQueue(arr){ localStorage.setItem(QKEY, JSON.stringify(arr)); }
function refreshQueueBadge(){ const n=loadQueue().length; document.getElementById('qinfo').textContent = `OPD Orders: ${n} pending`; }

function applyOrder(o){
  document.getElementById('pname').value = o.name||'';
  document.getElementById('ppid').value  = o.pid||'';
  document.getElementById('pref').value  = (o.ref||o.refBy||'OPD')+'';
  document.getElementById('pdate').value = todayISO();

  (o.items||[]).forEach(x=>{
    const test = x.test || x.name || x;
    if(!TEST_PARAMS[test]) return;
    TEST_PARAMS[test].forEach(p=>{
      const key = `${test}|${p.k}|${Date.now()}|${Math.random().toString(36).slice(2,6)}`;
      PREVIEW.push({ test, key, lab:p.lab, result:"", norm:p.norm||"" });
    });
  });
  redrawPreview();
  alert(`Loaded OPD order for ${o.pid||''} · ${o.name||''}`);
}

function loadNextOrder(pop=true){
  const q=loadQueue();
  if(!q.length){ alert('No pending OPD orders'); return; }
  const order = q.shift();
  if(pop) saveQueue(q);
  applyOrder(order);
  refreshQueueBadge();
}
document.getElementById('btnLoadNext').onclick = ()=> loadNextOrder(true);

/* ===== Keyboard shortcuts ===== */
document.addEventListener('keydown', (e)=>{
  const hot = (e.ctrlKey||e.metaKey) ? 'Ctrl+'+e.key.toUpperCase() : e.key;
  if(hot==='Escape'){ e.preventDefault(); document.getElementById('tSearch').focus(); document.getElementById('tSearch').select?.(); }
  if(hot==='Ctrl+S'){ e.preventDefault(); document.getElementById('btnSave').click(); }
  if(hot==='Ctrl+P'){ e.preventDefault(); document.getElementById('btnPrint').click(); }
  if(hot==='Ctrl+N'){ e.preventDefault(); PREVIEW=[]; redrawPreview(); document.getElementById('pname').value=''; document.getElementById('ppid').value=''; document.getElementById('pref').value=''; document.getElementById('page').value=''; document.getElementById('psex').value=''; document.getElementById('pdate').value=todayISO(); document.getElementById('tSearch').focus(); }
});

/* ===== init ===== */
document.getElementById('pdate').value = todayISO();
refreshQueueBadge();
window.addEventListener('storage', (e)=>{ if(e.key==='lab_tests_json'){ PRICE_MAP=loadCatalog(); renderParams(); updateTotalBadge(); }});
renderParams();
</script>
</body>
</html>