(function(){const UI_KEY='onesystem.ui_overrides';const PINS_KEY='onesystem.pins';const $=s=>document.querySelector(s);const read=(k,d={})=>{try{return JSON.parse(localStorage.getItem(k)||'null')||d}catch{return d}};const write=(k,v)=>{localStorage.setItem(k,JSON.stringify(v));try{window.dispatchEvent(new Event('ui_overrides_updated'))}catch(_){}};const fileToDataURL=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f)});const bName=$('#b_name');const bDoc=$('#b_docline');const bColor=$('#b_color');const bLogo=$('#b_logo');const bBanner=$('#b_banner');const pAdmin=$('#p_admin'),pDoc=$('#p_doctor'),pSup=$('#p_supervisor'),pFO=$('#p_fo');const fPh=$('#f_pharmacy'),fLab=$('#f_lab'),fAn=$('#f_analytics'),fTV=$('#f_tv');function loadUI(){const u=read(UI_KEY,{});if(bName)bName.value=u.name||'';if(bDoc)bDoc.value=u.doctorLine||'';if(bColor)bColor.value=u.brandColor||'#17B26A';if(u.logoDataUrl){const prev=document.getElementById('b_logo_preview');if(prev)prev.src=u.logoDataUrl}if(u.bannerDataUrl){const prev=document.getElementById('b_banner_preview');if(prev)prev.src=u.bannerDataUrl}const flags=u.flags||{};if(fPh)fPh.checked=String(flags.pharmacy||'on')!=='off';if(fLab)fLab.checked=String(flags.lab||'on')!=='off';if(fAn)fAn.checked=String(flags.analytics||'on')!=='off';if(fTV)fTV.checked=String(flags.tv||'on')!=='off'}function loadPins(){const P=read(PINS_KEY,{});if(pAdmin)pAdmin.value=P.admin||'4444';if(pDoc)pDoc.value=P.doctor||'1111';if(pSup)pSup.value=P.supervisor||'2222';if(pFO)pFO.value=P['front-office']||'3333'}async function saveBranding(){const u=read(UI_KEY,{});u.name=bName?.value?.trim()||'';u.doctorLine=bDoc?.value?.trim()||'';u.brandColor=bColor?.value||'#17B26A';if(bLogo&&bLogo.files&&bLogo.files[0]){u.logoDataUrl=await fileToDataURL(bLogo.files[0])}if(bBanner&&bBanner.files&&bBanner.files[0]){u.bannerDataUrl=await fileToDataURL(bBanner.files[0])}write(UI_KEY,u);alert('Branding saved.')}function savePins(){const obj={admin:(pAdmin?.value||'4444').trim(),doctor:(pDoc?.value||'1111').trim(),supervisor:(pSup?.value||'2222').trim(),'front-office':(pFO?.value||'3333').trim()};write(PINS_KEY,obj);alert('PINs saved.')}function resetPins(){localStorage.removeItem(PINS_KEY);loadPins();alert('PINs reset to defaults.')}function saveFlags(){const u=read(UI_KEY,{});u.flags={pharmacy:fPh?.checked?'on':'off',lab:fLab?.checked?'on':'off',analytics:fAn?.checked?'on':'off',tv:fTV?.checked?'on':'off'};write(UI_KEY,u);alert('Feature flags saved.')}function exportBrand(){const data={ui_overrides:read(UI_KEY,{}),pins:read(PINS_KEY,{}),_exported_at:new Date().toISOString()};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='clinicapp-branding-export.json';a.click();URL.revokeObjectURL(a.href)}function importBrand(ev){const file=ev.target.files[0];if(!file)return;const r=new FileReader();r.onload=()=>{try{const data=JSON.parse(String(r.result||'{}'));if(data.ui_overrides)localStorage.setItem(UI_KEY,JSON.stringify(data.ui_overrides));if(data.pins)localStorage.setItem(PINS_KEY,JSON.stringify(data.pins));window.dispatchEvent(new Event('ui_overrides_updated'));loadUI();loadPins();alert('Import complete.')}catch(e){alert('Invalid JSON')}};r.readAsText(file)}function resetBrand(){localStorage.removeItem(UI_KEY);loadUI();window.dispatchEvent(new Event('ui_overrides_updated'));alert('Branding reset.')}function wire(){const by=id=>document.getElementById(id);by('saveBrand')?.addEventListener('click',()=>saveBranding());by('exportBrand')?.addEventListener('click',exportBrand);by('importBrand')?.addEventListener('change',importBrand);by('resetBrand')?.addEventListener('click',resetBrand);by('savePins')?.addEventListener('click',savePins);by('resetPins')?.addEventListener('click',resetPins);by('saveFlags')?.addEventListener('click',saveFlags);by('broadcast')?.addEventListener('click',()=>window.dispatchEvent(new Event('ui_overrides_updated')))}document.addEventListener('DOMContentLoaded',()=>{loadUI();loadPins();wire()});})();