<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard ‚Äî CSV Demo</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    .wrap{max-width:1100px;margin:0 auto}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 12px}
    .chip{padding:10px 14px;border-radius:999px;background:var(--card-bg);border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow)}
    .section{background:var(--card-bg);margin:12px;padding:18px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .kpi{padding:14px;border-radius:14px;background:var(--t-blue);color:var(--c-blue);box-shadow:var(--shadow)}
    .kpi:nth-child(2){background:var(--t-mint);color:var(--c-mint)}
    .kpi:nth-child(3){background:var(--t-rose);color:var(--c-rose)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,.06);text-align:left}
    th{opacity:.8}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="banner">
      <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
    </header>

    <nav class="toolbar">
      <a class="chip" href="index.html">‚Üê Home</a>
      <button class="chip" id="btnForceRefresh">Force Refresh Cache</button>
    </nav>

    <section class="section">
      <h2 style="margin-bottom:8px;">Sales Analytics</h2>
      <div class="kpis">
        <div class="kpi">
          <div class="muted">Today (‚Çπ)</div>
          <div id="kpiToday" style="font-size:24px;font-weight:800">0.00</div>
        </div>
        <div class="kpi">
          <div class="muted">This Month (‚Çπ)</div>
          <div id="kpiMTD" style="font-size:24px;font-weight:800">0.00</div>
        </div>
        <div class="kpi">
          <div class="muted">Invoices Today</div>
          <div id="kpiCount" style="font-size:24px;font-weight:800">0</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Source: ./data/invoices.csv & ./data/invoice_items.csv</div>
    </section>

    <section class="section">
      <h3 style="margin-bottom:8px;">Staff (Today) ‚Äî View only</h3>
      <table id="tblStaff">
        <thead>
          <tr><th>Name</th><th>Role</th><th>Status</th><th>Note</th></tr>
        </thead>
        <tbody><tr><td colspan="4" class="muted">Loading‚Ä¶</td></tr></tbody>
      </table>
      <div class="muted" style="margin-top:8px">Source: ./data/staff_attendance.csv</div>
    </section>
  </div>

  <script>
    // Theme toggle
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;t.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    t.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const nxt=cur==='light'?'dark':'light';document.documentElement.dataset.theme=nxt;localStorage.theme=nxt;t.textContent=nxt==='light'?'üåû':'üåô'}

    // Force refresh / wipe caches + SW
    document.getElementById('btnForceRefresh').onclick = async () => {
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
        localStorage.clear();
        if('caches' in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
        alert('Cache & service worker cleared. The page will reload now.');
        location.reload(true);
      }catch(e){alert('Clear error: '+e.message)}
    };

    // ---------- CSV helpers ----------
    async function fetchCsv(path){
      const res = await fetch(path, {cache:'no-store'});
      if(!res.ok) throw new Error('Fetch failed: '+path);
      const txt = await res.text();
      return parseCsv(txt);
    }
    function parseCsv(text){
      // very small CSV parser (handles simple cases, quoted commas)
      const rows=[]; let i=0, cur='', inQ=false, row=[];
      while(i<text.length){
        const c=text[i++];
        if(c==='\"'){ inQ=!inQ; }
        else if(c===',' && !inQ){ row.push(cur); cur=''; }
        else if((c==='\n' || c==='\r') && !inQ){
          if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
        } else { cur+=c; }
      }
      if(cur!=='' || row.length) { row.push(cur); rows.push(row); }
      const header = rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length===header.length).map(r=>{
        const obj={}; header.forEach((h,idx)=>obj[h]=r[idx]); return obj;
      });
    }
    const fmt = n => (Number(n)||0).toFixed(2);
    const dISO = d => new Date(d).toISOString().slice(0,10);

    // ---------- Load & render ----------
    (async function(){
      try{
        const [invoices, items, att] = await Promise.all([
          fetchCsv('./data/invoices.csv'),
          fetchCsv('./data/invoice_items.csv'),
          fetchCsv('./data/staff_attendance.csv')
        ]);

        // KPIs
        const today = dISO(new Date());
        const monthStart = dISO(new Date(new Date().getFullYear(), new Date().getMonth(), 1));

        const todaysInv = invoices.filter(i => (i.invoice_date||i.date)===today);
        const mtdInv    = invoices.filter(i => (i.invoice_date||i.date) >= monthStart);

        const sum = arr => arr.reduce((s,i)=> s + Number(i.total_rs||i.total||0), 0);
        document.getElementById('kpiToday').textContent = fmt(sum(todaysInv));
        document.getElementById('kpiMTD').textContent   = fmt(sum(mtdInv));
        document.getElementById('kpiCount').textContent = todaysInv.length;

        // Staff (today)
        const tbody = document.querySelector('#tblStaff tbody');
        tbody.innerHTML = '';
        const todaysAtt = att.filter(a => (a.day||a.date)===today);
        if(!todaysAtt.length){
          tbody.innerHTML = '<tr><td colspan="4" class="muted">No data</td></tr>';
        }else{
          todaysAtt.forEach(a=>{
            const tr=document.createElement('tr');
            tr.innerHTML = `<td>${a.name||''}</td><td>${a.role||''}</td><td>${a.status||''}</td><td>${a.note||''}</td>`;
            tbody.appendChild(tr);
          });
        }
      }catch(e){
        console.error(e);
        alert('Error loading CSVs: '+e.message);
      }
    })();
  </script>
</body>
</html>
