<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard ‚Äì Dr. Charan Hospital</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    .wrap{max-width:1120px;margin:0 auto}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px;margin:8px 12px}
    .chip{height:42px;padding:0 16px;border-radius:999px;background:var(--card-bg);
      border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);display:grid;place-items:center}
    .section{background:var(--card-bg);margin:12px;padding:18px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .tiles{display:grid;gap:16px}
    @media(min-width:720px){.tiles{grid-template-columns:1fr 1fr}}
    .tile{border-radius:18px;padding:24px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06);
      text-decoration:none;color:inherit;display:block}
    .tile h2{font-size:26px;margin-bottom:8px;text-decoration:underline;text-underline-offset:4px}
    .tile p{color:var(--muted);font-size:16px}
    .t-lilac{background:linear-gradient(135deg,var(--t-lilac),#cab8ff);color:var(--c-lilac)}
    .t-blue{background:linear-gradient(135deg,var(--t-blue),#bcdfff);color:var(--c-blue)}
    .t-mint{background:linear-gradient(135deg,var(--t-mint),#aaf5d0);color:var(--c-mint)}
    .t-rose{background:linear-gradient(135deg,var(--t-rose),#ffb6cc);color:var(--c-rose)}
    .t-peach{background:linear-gradient(135deg,var(--t-peach),#ffb9ad);color:var(--c-peach)}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:10px}
    .kpi{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
    .kpi h4{font-size:14px;opacity:.85;margin-bottom:6px}
    .kpi .num{font-size:30px;font-weight:800}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Banner -->
    <header class="banner">
      <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
    </header>

    <!-- Toolbar -->
    <nav class="toolbar">
      <a class="chip" href="index.html">‚Üê Home</a>
      <button id="logoutBtn" class="chip">Logout</button>
      <button id="clearCacheBtn" class="chip">Clear Cache</button>
    </nav>

    <!-- Tiles -->
    <section class="section">
      <div class="tiles">
        <a class="tile t-lilac" href="analytics.html">
          <h2>Analytics</h2>
          <p>KPIs & weekly sales</p>
        </a>

        <a class="tile t-blue" href="pharmacy.html">
          <h2>Pharmacy</h2>
          <p>Today ‚Çπ<span id="todayAmt">0.00</span> ¬∑ MTD ‚Çπ<span id="mtdAmt">0.00</span> ¬∑ Top: <span id="topItem">‚Äî</span></p>
        </a>

        <a class="tile t-mint" href="bookings-status.html">
          <h2>Booking Status</h2>
          <p>Today / Week / Month counts</p>
        </a>

        <a class="tile t-rose" href="patients.html">
          <h2>Patients</h2>
          <p>Reminders & history ¬∑ <span id="dueCnt">0</span> due today</p>
        </a>

        <a class="tile t-peach" href="staff.html" style="grid-column: 1 / -1;">
          <h2>Staff</h2>
          <p>Roster & attendance (view-only)</p>
        </a>

        <a class="tile t-lilac" href="settings.html" style="grid-column: 1 / -1;">
          <h2>Settings</h2>
          <p>PINs, Staff, Patients</p>
        </a>
      </div>
    </section>

    <!-- Sales snapshot -->
    <section class="section">
      <h2 style="font-size:22px;margin-bottom:6px;">Sales Analytics</h2>
      <div class="kpis">
        <div class="kpi t-blue">
          <h4>Today (‚Çπ)</h4><div class="num" id="kToday">0.00</div>
        </div>
        <div class="kpi t-mint">
          <h4>This Month (‚Çπ)</h4><div class="num" id="kMTD">0.00</div>
        </div>
        <div class="kpi t-rose">
          <h4>Invoices Today</h4><div class="num" id="kInv">0</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Source: <code>./data/invoices.csv</code> & <code>./data/invoice_items.csv</code></div>
    </section>
  </div>

  <script>
    /* ===== Theme toggle ===== */
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;t.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    t.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const next=cur==='light'?'dark':'light';document.documentElement.dataset.theme=next;localStorage.theme=next;t.textContent=next==='light'?'üåû':'üåô'}

    /* ===== Session guard: Doctor only ===== */
    (function guard(){
      const sess = JSON.parse(localStorage.getItem('session')||'null');
      if(!sess || sess.role!=='doctor'){ location.replace('login.html'); }
    })();

    /* ===== Toolbar actions ===== */
    document.getElementById('logoutBtn').onclick=()=>{
      localStorage.removeItem('session'); location.replace('login.html');
    };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      localStorage.clear(); sessionStorage.clear();
      if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
      alert('Cache cleared. Reloading‚Ä¶'); location.reload();
    };

    /* ===== CSV helpers (works on GitHub Pages) ===== */
    async function loadCSV(path){
      const res = await fetch(path, {cache:'no-store'});
      if(!res.ok) return [];
      const text = await res.text();
      const [head, ...rows] = text.trim().split(/\r?\n/);
      const cols = head.split(',').map(s=>s.trim());
      return rows.map(r=>{
        const vals = r.split(',').map(s=>s.trim());
        const obj = {};
        cols.forEach((c,i)=>obj[c]=vals[i]??'');
        return obj;
      });
    }
    const fmt = n => (Number(n)||0).toFixed(2);
    const iso = d => new Date(d).toISOString().slice(0,10);

    /* ===== Sales snapshot from CSV ===== */
    (async function renderSales(){
      try{
        const inv = await loadCSV('data/invoices.csv');        // invoice_date,total_rs
        const items = await loadCSV('data/invoice_items.csv'); // invoice_id,item_name,qty,price_rs,amount_rs

        const today = iso(new Date());
        const mStart = iso(new Date(new Date().getFullYear(), new Date().getMonth(), 1));

        const invToday = inv.filter(i => (i.invoice_date || today) === today);
        const invMTD   = inv.filter(i => (i.invoice_date || today) >= mStart);

        const sum = (list, key) => list.reduce((s,o)=> s + (Number(o[key])||0), 0);

        const todayAmt = sum(invToday,'total_rs');
        const mtdAmt   = sum(invMTD,'total_rs');

        document.getElementById('kToday').textContent = fmt(todayAmt);
        document.getElementById('kMTD').textContent   = fmt(mtdAmt);
        document.getElementById('kInv').textContent   = invToday.length;

        // top item today (by revenue)
        const setTodayIds = new Set(invToday.map(i=>i.id));
        const map = {};
        items.filter(it=> setTodayIds.has(it.invoice_id)).forEach(it=>{
          const name = it.item_name || '‚Äî';
          const amt = Number(it.amount_rs)||((Number(it.qty)||0)*(Number(it.price_rs)||0));
          map[name]=(map[name]||0)+amt;
        });
        const top = Object.entries(map).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äî';
        document.getElementById('todayAmt').textContent = fmt(todayAmt);
        document.getElementById('mtdAmt').textContent   = fmt(mtdAmt);
        document.getElementById('topItem').textContent  = top;
      }catch(e){
        console.warn('CSV load failed', e);
      }
    })();

    /* ===== Patients ‚Äúdue today‚Äù from patients.csv (optional) ===== */
    (async function due(){
      try{
        const pts = await loadCSV('data/patients.csv'); // expect next_visit (YYYY-MM-DD) column if present
        const today = iso(new Date());
        const due = pts.filter(p => (p.next_visit||'') === today).length;
        document.getElementById('dueCnt').textContent = due;
      }catch(_){}
    })();
  </script>
</body>
</html>
