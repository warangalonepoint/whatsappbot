<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Analytics – Dr. Charan Hospital</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .wrap{max-width:1120px;margin:0 auto}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px;margin:8px 12px}
    .chip{height:42px;padding:0 16px;border-radius:999px;background:var(--card-bg);
      border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);display:grid;place-items:center}
    .section{background:var(--card-bg);margin:12px;padding:18px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:10px}
    .kpi{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
    .kpi h4{font-size:14px;opacity:.85;margin-bottom:6px}
    .kpi .num{font-size:28px;font-weight:800}
    canvas{max-width:100%;margin-top:20px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Toolbar -->
    <nav class="toolbar">
      <a class="chip" href="index.html">← Home</a>
      <button id="logoutBtn" class="chip">Logout</button>
      <button id="clearCacheBtn" class="chip">Clear Cache</button>
    </nav>

    <!-- KPIs -->
    <section class="section">
      <h2 style="margin-bottom:12px;">Sales KPIs</h2>
      <div class="kpis">
        <div class="kpi t-blue">
          <h4>Today (₹)</h4><div class="num" id="kToday">0.00</div>
        </div>
        <div class="kpi t-mint">
          <h4>This Month (₹)</h4><div class="num" id="kMTD">0.00</div>
        </div>
        <div class="kpi t-rose">
          <h4>Invoices Today</h4><div class="num" id="kInv">0</div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="section">
      <h2>Weekly Sales Trend</h2>
      <canvas id="lineChart"></canvas>
    </section>

    <section class="section">
      <h2>Sales by Item (Today)</h2>
      <canvas id="pieChart"></canvas>
    </section>
  </div>

  <script>
    /* ===== Guard: Doctor only ===== */
    (function guard(){
      const sess = JSON.parse(localStorage.getItem('session')||'null');
      if(!sess || sess.role!=='doctor'){ location.replace('index.html'); }
    })();

    /* ===== Toolbar actions ===== */
    document.getElementById('logoutBtn').onclick=()=>{
      localStorage.removeItem('session'); location.replace('index.html');
    };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      localStorage.clear();sessionStorage.clear();
      if('caches' in window){const ks=await caches.keys();await Promise.all(ks.map(k=>caches.delete(k)));}
      alert('Cache cleared. Reloading…');location.reload();
    };

    /* ===== CSV helpers ===== */
    async function loadCSV(path){
      const res = await fetch(path, {cache:'no-store'});
      if(!res.ok) return [];
      const text = await res.text();
      const [head, ...rows] = text.trim().split(/\r?\n/);
      const cols = head.split(',').map(s=>s.trim());
      return rows.map(r=>{
        const vals = r.split(',').map(s=>s.trim());
        const obj = {};
        cols.forEach((c,i)=>obj[c]=vals[i]??'');
        return obj;
      });
    }
    const fmt = n => (Number(n)||0).toFixed(2);
    const iso = d => new Date(d).toISOString().slice(0,10);

    /* ===== Analytics ===== */
    (async function render(){
      try{
        const inv = await loadCSV('data/invoices.csv');
        const items = await loadCSV('data/invoice_items.csv');

        const today = iso(new Date());
        const mStart = iso(new Date(new Date().getFullYear(), new Date().getMonth(), 1));

        const invToday = inv.filter(i => i.invoice_date === today);
        const invMTD   = inv.filter(i => i.invoice_date >= mStart);

        const sum = (list, key) => list.reduce((s,o)=> s + (Number(o[key])||0), 0);

        const todayAmt = sum(invToday,'total_rs');
        const mtdAmt   = sum(invMTD,'total_rs');

        document.getElementById('kToday').textContent = fmt(todayAmt);
        document.getElementById('kMTD').textContent   = fmt(mtdAmt);
        document.getElementById('kInv').textContent   = invToday.length;

        /* Line chart: last 7 days */
        const days = [...Array(7)].map((_,i)=>{
          const d = new Date(); d.setDate(d.getDate()-i);
          return iso(d);
        }).reverse();

        const sales = days.map(d=> sum(inv.filter(i=>i.invoice_date===d),'total_rs'));

        new Chart(document.getElementById('lineChart'), {
          type:'line',
          data:{labels:days, datasets:[{label:'Daily Sales (₹)',data:sales,fill:false,borderColor:'#3b82f6'}]},
          options:{responsive:true,plugins:{legend:{display:false}}}
        });

        /* Pie chart: today’s items */
        const map = {};
        items.filter(it=> invToday.some(inv=>inv.id===it.invoice_id))
             .forEach(it=>{
          const name = it.item_name||'—';
          const amt = Number(it.amount_rs)||((Number(it.qty)||0)*(Number(it.price_rs)||0));
          map[name]=(map[name]||0)+amt;
        });

        new Chart(document.getElementById('pieChart'), {
          type:'pie',
          data:{labels:Object.keys(map), datasets:[{data:Object.values(map)}]},
          options:{responsive:true}
        });

      }catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>
