<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pharmacy ‚Äì Billing (CSV Demo)</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=5"/>

  <style>
    .wrap{max-width:1140px;margin:0 auto}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 12px}
    .chip{height:40px;padding:0 14px;border-radius:999px;background:var(--card-bg);
      border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);display:inline-flex;align-items:center}
    .panel{border-radius:18px;background:var(--card-bg);padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06);margin:12px}
    .panel.lilac{background:linear-gradient(135deg,var(--t-lilac),#cab8ff)}
    .panel.blue{background:linear-gradient(135deg,var(--t-blue),#bcdfff)}
    .panel.mint{background:linear-gradient(135deg,var(--t-mint),#aaf5d0)}
    .panel.peach{background:linear-gradient(135deg,var(--t-peach),#ffb9ad)}
    .panel .inner{background:var(--card-bg);border-radius:16px;padding:14px;border:1px solid rgba(0,0,0,.06)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (min-width:840px){ .row{grid-template-columns:repeat(3,1fr)} }
    .row .col-2{grid-column:span 2}
    .row .col-3{grid-column:span 3}
    label{font-size:.9rem;color:var(--muted)}
    input,select{height:42px;padding:8px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:var(--card-bg);color:var(--fg);width:100%}
    h2{margin-bottom:10px}
    .btn{background:var(--accent);color:#fff;border:none;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;color:var(--fg);border:1px solid rgba(0,0,0,.08)}
    .btn.light{background:#f3f4f6;color:#111827}
    .btn.danger{background:#ef4444}
    .right{margin-left:auto}
    /* Items table (responsive) */
    .items-head,.items-row{display:grid;gap:10px;align-items:center}
    .items-head{font-weight:700;opacity:.9;margin-bottom:6px}
    .items-row{margin-bottom:10px}
    /* 4 columns desktop: name qty price line */
    @media (min-width:840px){
      .items-head,.items-row{grid-template-columns: 1fr 120px 140px 140px}
    }
    /* 2 columns mobile: name | qty+price+line */
    @media (max-width:839.98px){
      .items-head{grid-template-columns:1fr 1fr}
      .items-head div:nth-child(2){text-align:right}
      .items-row{grid-template-columns:1fr 1fr}
      .items-row .stack{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
      .items-row .line{justify-self:end}
    }
    .del{background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:10px;height:38px;padding:0 10px;cursor:pointer}
    .muted{color:var(--muted)}
    .tot{font-size:1.25rem;font-weight:800}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--t-mint);color:var(--c-mint);font-weight:700}
    .hint{font-size:12px;color:var(--muted)}
    .sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (min-width:840px){ .sum-grid{grid-template-columns:repeat(3,1fr)} }
    .mt8{margin-top:8px}
    .mb8{margin-bottom:8px}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Top actions -->
  <nav class="toolbar">
    <a class="chip" href="admin.html">‚Üê Supervisor</a>
    <a class="chip" href="pharmacy-report.html">üìä Reports</a>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
    <span class="chip">Mode: <b style="margin-left:6px">CSV Demo</b></span>
  </nav>

  <!-- Invoice Details -->
  <section class="panel blue">
    <div class="inner">
      <h2>Invoice Details</h2>
      <div class="row">
        <div>
          <label>Invoice #</label>
          <input id="invNo" placeholder="e.g., INV-001"/>
        </div>
        <div>
          <label>Date</label>
          <input id="invDate" type="date"/>
        </div>
        <div>
          <label>Doctor (optional)</label>
          <input id="doctor" placeholder="Dr. Name"/>
        </div>
        <div>
          <label>Payment Mode</label>
          <select id="payMode">
            <option>Cash</option><option>Card</option><option>UPI</option><option>Mixed</option>
          </select>
        </div>
      </div>

      <h3 class="mt8">Patient</h3>
      <div class="row">
        <div class="col-2">
          <label>Patient Name</label>
          <input id="patName" placeholder="Full name"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="patPhone" placeholder="10-digit" inputmode="numeric" maxlength="10"/>
        </div>
      </div>
    </div>
  </section>

  <!-- Items -->
  <section class="panel mint">
    <div class="inner">
      <div class="row" style="grid-template-columns:1fr auto auto;align-items:center">
        <h2 style="margin:0">Items</h2>
        <button id="btnAdd" class="btn">+ Add Item</button>
        <button id="btnClear" class="btn light">üóëÔ∏è Clear</button>
      </div>

      <div class="items-head mt8" id="itemsHead">
        <div>Item</div>
        <div class="muted" style="text-align:right">Qty ‚Ä¢ Price ‚Ä¢ Line</div>
      </div>

      <div id="items"></div>
    </div>
  </section>

  <!-- Summary -->
  <section class="panel peach">
    <div class="inner">
      <h2>Summary</h2>
      <div class="sum-grid">
        <div>
          <label>Invoice Discount %</label>
          <input id="discPct" type="number" step="0.01" value="0"/>
        </div>
        <div>
          <label>Invoice Discount ‚Çπ</label>
          <input id="discRs" type="number" step="0.01" value="0"/>
        </div>
        <div>
          <label>Paid ‚Çπ</label>
          <input id="paidRs" type="number" step="0.01" value="0"/>
        </div>
      </div>

      <div class="row mt8" style="grid-template-columns:repeat(4,1fr)">
        <div><label class="muted">Items Total ‚Çπ</label><div class="tot" id="itemsTotal">0.00</div></div>
        <div><label class="muted">Discount ‚Çπ</label><div class="tot" id="discShow">0.00</div></div>
        <div><label class="muted">Invoice Total ‚Çπ</label><div class="tot" id="grandTotal">0.00</div></div>
        <div><label class="muted">Balance ‚Çπ</label><div class="tot" id="balance">0.00</div></div>
      </div>

      <div class="row mt8" style="grid-template-columns:auto auto auto 1fr;align-items:center">
        <button id="btnSaveDraft" class="btn ghost">üíæ Save Draft (local)</button>
        <button id="btnFinalize"   class="btn">Finalize & Export</button>
        <button id="btnPrint"      class="btn light">üñ®Ô∏è Print</button>
        <span class="right hint">Exports <code>invoices.csv</code> & <code>invoice_items.csv</code> for upload.</span>
      </div>
    </div>
  </section>
</div>

<script src="js/csv.js?v=5"></script>
<script>
/* ===== Theme & utils ===== */
const tBtn=document.getElementById('themeToggle');
if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; tBtn.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
tBtn.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light';
  document.documentElement.dataset.theme=next; localStorage.theme=next; tBtn.textContent=next==='light'?'üåû':'üåô'; };
document.getElementById('clearCacheBtn').onclick=()=>{ CSV.clear(); localStorage.removeItem('ph_inv'); alert('Cleared local cache.'); };

const toISO = d => new Date(d).toISOString().slice(0,10);
const todayISO = toISO(new Date());
document.getElementById('invDate').value = todayISO;

const els = {
  invNo:invNo, invDate:invDate, doctor, payMode, patName, patPhone,
  discPct:discPct, discRs:discRs, paidRs:paidRs,
  itemsWrap:document.getElementById('items'),
  itemsTotal:itemsTotal, discShow:discShow, grandTotal:grandTotal, balance:balance
};

function num(v){ v = (v??0).toString().trim(); if(!v) return 0; return Number(v)||0; }
function money(n){ return num(n).toFixed(2); }

/* ===== Items handling ===== */
let items = []; // {name,qty,price,amount}

function newRow(r={name:'',qty:1,price:0}){
  const amount = num(r.qty)*num(r.price);
  const row = {name:r.name, qty:num(r.qty)||1, price:num(r.price)||0, amount};
  items.push(row);
  renderItems();
}

function delRow(idx){ items.splice(idx,1); renderItems(); }

function renderItems(){
  els.itemsWrap.innerHTML='';
  if(!items.length){
    const div=document.createElement('div');
    div.className='muted mb8'; div.textContent='No items yet ‚Äì add some.';
    els.itemsWrap.appendChild(div);
  }
  items.forEach((r,idx)=>{
    const wrap=document.createElement('div');
    wrap.className='items-row';
    // Desktop layout
    wrap.innerHTML = window.matchMedia('(min-width:840px)').matches
      ? `
        <input placeholder="Item name" value="${r.name}" data-f="name">
        <input type="number" step="1" min="1" value="${r.qty}" data-f="qty">
        <input type="number" step="0.01" value="${r.price}" data-f="price">
        <div class="tot line">‚Çπ <span data-f="amt">${money(r.amount)}</span> <button class="del" title="Remove">‚úñ</button></div>
      `
      : `
        <input class="col-2" placeholder="Item name" value="${r.name}" data-f="name">
        <div class="stack">
          <input type="number" step="1" min="1" value="${r.qty}" data-f="qty" placeholder="Qty">
          <input type="number" step="0.01" value="${r.price}" data-f="price" placeholder="Price">
          <div class="tot line" style="display:flex;align-items:center;justify-content:space-between">
            <span>‚Çπ <span data-f="amt">${money(r.amount)}</span></span>
            <button class="del" title="Remove">‚úñ</button>
          </div>
        </div>
      `;
    // Wire
    wrap.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input',()=>{
        const f=inp.dataset.f;
        if(f==='name'){ r.name=inp.value; }
        if(f==='qty'){ r.qty=Math.max(1,num(inp.value)); inp.value=r.qty; }
        if(f==='price'){ r.price=num(inp.value); }
        r.amount = r.qty*r.price;
        wrap.querySelector('[data-f="amt"]').textContent = money(r.amount);
        recalc();
      });
    });
    wrap.querySelector('.del').onclick=()=>delRow(idx);
    els.itemsWrap.appendChild(wrap);
  });
  recalc();
}

function recalc(){
  const itemsTotal = items.reduce((s,i)=> s + i.amount, 0);
  let dPct = Math.max(0, num(els.discPct.value));
  let dRs  = Math.max(0, num(els.discRs.value));
  // If both given, discount = max of the two (and show that)
  const pctRs = itemsTotal * dPct/100;
  const useDisc = Math.max(dRs, pctRs);
  const grand = Math.max(0, itemsTotal - useDisc);
  const paid = Math.min(grand, num(els.paidRs.value));
  const bal  = Math.max(0, grand - paid);

  els.itemsTotal.textContent = money(itemsTotal);
  els.discShow.textContent   = money(useDisc);
  els.grandTotal.textContent = money(grand);
  els.balance.textContent    = money(bal);
}

/* sync totals on input */
['discPct','discRs','paidRs'].forEach(id=> els[id].addEventListener('input', recalc));

/* ===== Draft & Export ===== */
function collectInvoice(){
  const inv = {
    invoice_no: els.invNo.value.trim() || `INV-${Date.now().toString().slice(-6)}`,
    invoice_date: els.invDate.value || todayISO,
    patient_name: els.patName.value.trim(),
    patient_phone: els.patPhone.value.trim(),
    doctor_name: els.doctor.value.trim(),
    discount_pct: money(els.discPct.value),
    discount_rs : money(els.discRs.value),
    total_rs    : els.grandTotal.textContent,
    paid_rs     : money(els.paidRs.value),
    balance_rs  : els.balance.textContent,
    pay_mode    : els.payMode.value
  };
  return inv;
}

function saveDraft(){
  const inv = collectInvoice();
  const data = {inv, items};
  localStorage.setItem('ph_inv', JSON.stringify(data));
  alert('Draft saved in this device.');
}

function loadDraft(){
  const raw = localStorage.getItem('ph_inv'); if(!raw) return;
  try{
    const data = JSON.parse(raw);
    const v = data.inv||{};
    els.invNo.value = v.invoice_no||'';
    els.invDate.value = v.invoice_date||todayISO;
    els.patName.value = v.patient_name||'';
    els.patPhone.value = v.patient_phone||'';
    els.doctor.value = v.doctor_name||'';
    els.payMode.value = v.pay_mode||'Cash';
    els.discPct.value = v.discount_pct||0;
    els.discRs.value = v.discount_rs||0;
    els.paidRs.value = v.paid_rs||0;
    items = (data.items||[]).map(r=>({name:r.name||'',qty:num(r.qty)||1,price:num(r.price)||0,amount:num(r.amount)||0}));
    renderItems();
  }catch(e){}
}

function downloadCSV(filename, rows){
  if(!rows.length){ alert('Nothing to export.'); return; }
  const header = Object.keys(rows[0]);
  const csv = [header.join(',')].concat(rows.map(r=> header.map(h=>{
    const v = (r[h]??'').toString().replaceAll('"','""');
    return /[",\n]/.test(v) ? `"${v}"` : v;
  }).join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url,download:filename});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function finalizeExport(){
  if(!items.length){ alert('Add at least one item.'); return; }
  const inv = collectInvoice();
  // items csv rows
  const itemRows = items.map(it=>({
    invoice_no: inv.invoice_no,
    item_name: it.name||'Item',
    qty: it.qty,
    price_rs: money(it.price),
    amount_rs: money(it.amount)
  }));
  downloadCSV('invoice_items.csv', itemRows);
  downloadCSV('invoices.csv', [inv]);
  alert('Exported two CSVs. Upload them to /data/ to include in reports.');
}

function printSimple(){
  window.print();
}

/* ===== Buttons ===== */
document.getElementById('btnAdd').onclick = ()=> newRow();
document.getElementById('btnClear').onclick = ()=>{ items=[]; renderItems(); };
document.getElementById('btnSaveDraft').onclick = saveDraft;
document.getElementById('btnFinalize').onclick = finalizeExport;
document.getElementById('btnPrint').onclick = printSimple;

/* ===== Boot ===== */
newRow({}); // one blank line to start
loadDraft();
recalc();
</script>
</body>
</html>
