
<!doctype html><html lang="en" data-theme="light">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pharmacy Billing – CSV Demo</title><link rel="stylesheet" href="styles.css"/><script src="js/csv.js"></script></head>
<body><div class="wrap">
<header class="banner"><a class="chip floating-toggle" href="admin.html">← Admin</a></header>
<section class="card"><h2>Invoice</h2>
  <div class="grid">
    <div class="card">
      <label>Invoice #</label><input id="invno" placeholder="e.g., 1002"/>
      <label>Date</label><input id="invdate" type="date"/>
      <label>Patient Name</label><input id="pname"/>
      <label>Patient Phone</label><input id="pphone"/>
    </div>
    <div class="card">
      <div class="row"><div class="tag">Items</div><button class="btn" id="addItem">+ Add Item</button></div>
      <table id="items"></table>
      <div class="row">
        <div class="chip">Total ₹ <b id="total">0.00</b></div>
        <div class="chip">Paid ₹ <b id="paid">0.00</b></div>
        <div class="chip">Balance ₹ <b id="bal">0.00</b></div>
      </div>
      <div class="row">
        <button class="btn" id="save">Finalize & Save</button>
      </div>
    </div>
  </div>
</section></div>
<script>
let items=[];
function renderItems(){
  const head=['Item','Qty','Price','Line Total','']; 
  const rows=[head].concat(items.map((it,i)=>[
    `<input data-f="name" data-i="${i}" placeholder="Name" value="${it.name||''}">`,
    `<input data-f="qty" data-i="${i}" type="number" min="1" value="${it.qty||1}">`,
    `<input data-f="price" data-i="${i}" type="number" min="0" step="0.01" value="${it.price||0}">`,
    (Number(it.qty||1)*Number(it.price||0)).toFixed(2),
    `<button class="chip" data-del="${i}">✕</button>`
  ]));
  document.getElementById('items').innerHTML=rows.map((r,i)=>'<tr>'+r.map(c=>`<${i?'td':'th'}>${c}</${i?'td':'th'}>`).join('')+'</tr>').join('');
  const total = items.reduce((s,it)=> s+(Number(it.qty||1)*Number(it.price||0)),0);
  document.getElementById('total').textContent=total.toFixed(2);
  document.getElementById('paid').textContent=total.toFixed(2);
  document.getElementById('bal').textContent='0.00';
}
document.addEventListener('input',e=>{
  if(e.target.dataset.f){
    const i=+e.target.dataset.i; const f=e.target.dataset.f;
    items[i][f]= e.target.type==='number' ? Number(e.target.value||0) : e.target.value;
    renderItems();
  }
});
document.addEventListener('click',e=>{
  if(e.target.dataset.del){ items.splice(+e.target.dataset.del,1); renderItems(); }
});
document.getElementById('addItem').onclick=()=>{ items.push({name:'',qty:1,price:0}); renderItems(); };
document.getElementById('invdate').value=new Date().toISOString().slice(0,10);
document.getElementById('save').onclick=()=>{
  const id='inv'+Math.random().toString(36).slice(2,8);
  const total=items.reduce((s,it)=> s+(Number(it.qty||1)*Number(it.price||0)),0);
  CsvDB.insert('invoices',{
    id,invoice_no:document.getElementById('invno').value||'1002',invoice_date:document.getElementById('invdate').value,
    patient_name:document.getElementById('pname').value,patient_phone:document.getElementById('pphone').value,
    total_rs:String(total),paid_rs:String(total),balance_rs:'0'
  });
  items.forEach((it,idx)=> CsvDB.insert('invoice_items',{id:'it'+id+idx,invoice_id:id,item_name:it.name,qty:String(it.qty||1),price_rs:String(it.price||0),amount_rs:String((it.qty||1)*(it.price||0))}));
  alert('Saved to local CSV DB'); items=[]; renderItems();
};
renderItems();
</script>
</body></html>
