<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy Reports ‚Äî CSV Demo</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    .wrap{max-width:1100px;margin:0 auto}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 12px}
    .chip{padding:10px 14px;border-radius:999px;background:var(--card-bg);border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow)}
    .section{background:var(--card-bg);margin:12px;padding:18px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .kpi{padding:14px;border-radius:14px;background:var(--t-blue);color:var(--c-blue);box-shadow:var(--shadow)}
    .kpi:nth-child(2){background:var(--t-mint);color:var(--c-mint)}
    .kpi:nth-child(3){background:var(--t-rose);color:var(--c-rose)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,.06);text-align:left}
    th{opacity:.8}
    .muted{color:var(--muted)}
    canvas{width:100%;max-width:520px;aspect-ratio:1/1}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="banner">
      <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
    </header>

    <nav class="toolbar">
      <a class="chip" href="index.html">‚Üê Home</a>
      <button class="chip" id="btnForceRefresh">Force Refresh Cache</button>
    </nav>

    <section class="section">
      <h2 style="margin-bottom:12px;">Filters</h2>
      <div class="toolbar" style="padding:0">
        <label class="chip">From <input id="from" type="date" style="margin-left:8px"></label>
        <label class="chip">To <input id="to" type="date" style="margin-left:8px"></label>
        <button class="chip" id="btnApply">Apply</button>
      </div>
      <div class="muted">Source: ./data/invoices.csv & ./data/invoice_items.csv</div>
    </section>

    <section class="section">
      <h3 style="margin-bottom:8px;">Summary</h3>
      <div class="grid">
        <div class="kpi"><div class="muted">Total (‚Çπ)</div><div id="sumTotal" style="font-size:24px;font-weight:800">0.00</div></div>
        <div class="kpi"><div class="muted">Paid (‚Çπ)</div><div id="sumPaid" style="font-size:24px;font-weight:800">0.00</div></div>
        <div class="kpi"><div class="muted">Invoices</div><div id="sumInv" style="font-size:24px;font-weight:800">0</div></div>
      </div>
    </section>

    <section class="section">
      <h3 style="margin-bottom:8px;">Top Items (by sales)</h3>
      <div id="topItemsWrap" class="muted">Loading‚Ä¶</div>
    </section>

    <section class="section">
      <h3 style="margin-bottom:8px;">Invoices (list)</h3>
      <table id="tbl">
        <thead><tr><th>Date</th><th>No.</th><th>Patient</th><th>Total ‚Çπ</th><th>Paid ‚Çπ</th></tr></thead>
        <tbody><tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr></tbody>
      </table>
    </section>
  </div>

  <script>
    // Theme toggle
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;t.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    t.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const nxt=cur==='light'?'dark':'light';document.documentElement.dataset.theme=nxt;localStorage.theme=nxt;t.textContent=nxt==='light'?'üåû':'üåô'}

    // Force refresh
    document.getElementById('btnForceRefresh').onclick = async () => {
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
        localStorage.clear();
        if('caches' in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
        alert('Cache & service worker cleared. The page will reload now.');
        location.reload(true);
      }catch(e){alert('Clear error: '+e.message)}
    };

    // CSV helpers
    async function fetchCsv(path){
      const res = await fetch(path, {cache:'no-store'});
      if(!res.ok) throw new Error('Fetch failed: '+path);
      const txt = await res.text();
      return parseCsv(txt);
    }
    function parseCsv(text){
      const rows=[]; let i=0, cur='', inQ=false, row=[];
      while(i<text.length){
        const c=text[i++];
        if(c==='\"'){ inQ=!inQ; }
        else if(c===',' && !inQ){ row.push(cur); cur=''; }
        else if((c==='\n' || c==='\r') && !inQ){
          if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
        } else { cur+=c; }
      }
      if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
      const header = rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length===header.length).map(r=>{
        const obj={}; header.forEach((h,idx)=>obj[h]=r[idx]); return obj;
      });
    }
    const dISO = d => new Date(d).toISOString().slice(0,10);
    const fmt = n => (Number(n)||0).toFixed(2);

    let invoices=[], items=[];

    async function loadAll(){
      [invoices, items] = await Promise.all([
        fetchCsv('./data/invoices.csv'),
        fetchCsv('./data/invoice_items.csv')
      ]);

      // default window = this month
      const from = document.getElementById('from');
      const to = document.getElementById('to');
      const now=new Date();
      from.value = dISO(new Date(now.getFullYear(), now.getMonth(), 1));
      to.value   = dISO(now);

      apply();
    }

    function apply(){
      const f=document.getElementById('from').value;
      const t=document.getElementById('to').value || dISO(new Date());

      const inrange = invoices.filter(i => {
        const d=i.invoice_date || i.date;
        return d>=f && d<=t;
      });

      // KPIs
      const total = inrange.reduce((s,i)=> s + Number(i.total_rs||i.total||0), 0);
      const paid  = inrange.reduce((s,i)=> s + Number(i.paid_rs||i.paid||0), 0);
      document.getElementById('sumTotal').textContent = fmt(total);
      document.getElementById('sumPaid').textContent  = fmt(paid);
      document.getElementById('sumInv').textContent   = inrange.length;

      // Table
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      if(!inrange.length){
        tb.innerHTML = '<tr><td colspan="5" class="muted">No invoices</td></tr>';
      }else{
        inrange.forEach(i=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${i.invoice_date||i.date||''}</td>
                          <td>${i.invoice_no||i.number||''}</td>
                          <td>${i.patient_name||''}</td>
                          <td>${fmt(i.total_rs||i.total||0)}</td>
                          <td>${fmt(i.paid_rs||i.paid||0)}</td>`;
          tb.appendChild(tr);
        });
      }

      // Top Items
      const invIds = new Set(inrange.map(i=>i.id||i.invoice_id||i.invoice_no));
      const linked = items.filter(it=>{
        const key = it.invoice_id || it.invoice_no;
        return invIds.has(key);
      });
      const tally = {};
      linked.forEach(it=>{
        const name = it.item_name || it.name || '‚Äî';
        const amt  = Number(it.amount_rs || ( (Number(it.price_rs||it.price||0)) * (Number(it.qty||1)) ));
        tally[name] = (tally[name]||0) + amt;
      });
      const top = Object.entries(tally).sort((a,b)=>b[1]-a[1]).slice(0,8);
      const wrap = document.getElementById('topItemsWrap');
      if(!top.length){ wrap.textContent = 'No items in range.'; }
      else{
        const ul=document.createElement('ul');
        ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
        top.forEach(([name,amt])=>{
          const li=document.createElement('li');
          li.style.padding='6px 0';
          li.innerHTML = `<strong>${name}</strong> ‚Äî ‚Çπ ${fmt(amt)}`;
          ul.appendChild(li);
        });
        wrap.innerHTML=''; wrap.appendChild(ul);
      }
    }

    document.getElementById('btnApply').onclick = apply;

    loadAll().catch(e=>{
      console.error(e); alert('Error loading CSVs: '+e.message);
    });
  </script>
</body>
</html>
