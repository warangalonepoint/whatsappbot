<!doctype html>
<html lang="en">
<head>
<script src="./config/config.js"></script>
<script src="./scripts/db.js"></script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GST Reports · Pharmacy · Clinic PWA</title>
<link rel="manifest" href="./manifest.json"/>
<link rel="stylesheet" href="./styles.css"/>
<style>
:root{
  --bg-gradient:linear-gradient(145deg,#eef3f1,#f0eef9,#fff2eb);
  --mint:#D6E5DD;--lav:#DED8F2;--peach:#FFE8D9;--teal:#C8F5E4;
  --card:#fff;--ink:#0f172a;--muted:#475569;--primary:#139a5b;
  --r:16px;--shadow:0 6px 18px rgba(0,0,0,.08);
}
:root{--header-tint:#C8F5E4;--header-tint-rgba:200,245,228;--banner-tint:#DED8F2;--banner-tint-rgba:222,216,242}
*{box-sizing:border-box}
body{margin:0;font:14px/1.45 system-ui;background:var(--bg-gradient);color:var(--ink);}
.wrap{max-width:1100px;margin:0 auto;padding:0 10px}
a{color:inherit;text-decoration:none}

.header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;
background:rgba(var(--header-tint-rgba),.7);border:1px solid #0001;border-radius:12px;
margin-top:10px;box-shadow:var(--shadow);}
.header .logo{height:40px}
.btn{background:#fff;border:1px solid #cbd5e1;border-radius:20px;padding:6px 14px;font-weight:600;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff;border:none}
.btn:hover{background:#f1f5f9}

.banner{position:relative;overflow:hidden;border-radius:var(--r);margin:10px 0;background:var(--banner-tint)}
.banner img{width:100%;transform:scale(.65);display:block;border-radius:var(--r);mix-blend-mode:multiply;opacity:.95}
.banner::after{content:"";position:absolute;inset:0;
background:linear-gradient(0deg,rgba(var(--banner-tint-rgba),.3),rgba(var(--banner-tint-rgba),.3))}

.card{background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:12px}
.table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
.table th,.table td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.table th{background:#f1f5f9}
.total{font-weight:700;font-size:15px;text-align:right;padding:4px 0}
.footer{text-align:center;padding:16px 4px;font-size:13px;color:var(--muted);margin:22px 0 14px}
.filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
.box{background:#fff9;backdrop-filter:blur(6px);border-radius:var(--r);padding:10px;text-align:center;box-shadow:var(--shadow)}
.box h3{margin:0;font-size:20px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <img class="logo" src="./assets/logo.png" alt="logo">
    <div>
      <div style="font-weight:700;font-size:18px">GST Reports</div>
      <div style="font-size:13px;color:var(--muted)">Sales vs Purchase · Monthly Summary</div>
    </div>
    <div class="row" style="display:flex;gap:6px">
      <a class="btn" href="./pharmacy.html">Pharmacy Hub</a>
      <a class="btn" href="./index.html">Home</a>
    </div>
  </div>

  <div class="banner"><img src="./assets/banner.png" alt="Clinic Banner"></div>

  <div class="card" style="background:var(--teal)">
    <div class="filters">
      <label>Month :</label><input type="month" id="month">
      <button class="btn primary" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnCSV">Export CSV</button>
    </div>

    <table class="table" id="gstTable">
      <thead>
        <tr><th>GST Slab (%)</th><th>Sales Value (₹)</th><th>Purchase Value (₹)</th><th>Net GST Diff (₹)</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="3" class="total">Net Payable GST</td><td id="netPay">0.00</td></tr></tfoot>
    </table>

    <div class="summary">
      <div class="box"><h3 id="saleTot">0.00</h3><small>Total Sales</small></div>
      <div class="box"><h3 id="purchTot">0.00</h3><small>Total Purchases</small></div>
      <div class="box"><h3 id="gstTot">0.00</h3><small>GST Net Payable</small></div>
    </div>
  </div>

  <div class="footer">© 2025 <strong>Powered by Onestop AI Services</strong> · All Rights Reserved</div>
</div>

<script>
/* ===================== Branding sync ===================== */
const THEMES = {
  pastel: {'--bg-gradient':'linear-gradient(145deg,#f4f8f6,#f3f0fa,#fff4ec)','--mint':'#E8F6ED','--lav':'#F0EAFE','--peach':'#FFF3E8','--card':'#fff','--ink':'#0f172a','--muted':'#475569','--primary':'#17B26A'},
  glass:  {'--bg-gradient':'linear-gradient(135deg,#eef2ff,#ecfeff,#fef9c3)','--mint':'#E0F2FE','--lav':'#E9D5FF','--peach':'#FFE4E6','--card':'#fff','--ink':'#0f172a','--muted':'#475569','--primary':'#0EA5E9'},
  neo:    {'--bg-gradient':'linear-gradient(145deg,#f1f5f9,#e2e8f0,#f8fafc)','--mint':'#E2F7EC','--lav':'#EDE9FE','--peach':'#FFEAD5','--card':'#fff','--ink':'#0f172a','--muted':'#475569','--primary':'#111827'},
  iphone: {'--bg-gradient':'linear-gradient(180deg,#f7f7f7,#f0f0f0)','--mint':'#E6F4EA','--lav':'#EEE7FF','--peach':'#FFE7D6','--card':'#fff','--ink':'#111','--muted':'#4b5563','--primary':'#0A84FF'}
};
function applyTheme(name){
  const m = THEMES[name] || THEMES.pastel;
  const root = document.documentElement;
  Object.entries(m).forEach(([k,v])=> root.style.setProperty(k,v));
}
function applyBranding(b){
  applyTheme(b.theme||'pastel');
  document.getElementById('hdrLogo').src   = b.logoUrl || '../assets/logo.png';
  document.getElementById('hdrBanner').src = b.bannerUrl || '../assets/banner.png';
  document.documentElement.style.setProperty('--banner-h',  `${Number(b.bannerH||160)}px`);
  document.documentElement.style.setProperty('--banner-fit', b.bannerFit||'contain');
}
function readLSBranding(){ try{ return JSON.parse(localStorage.getItem('branding_json')||'null')||null; }catch{ return null; } }
async function loadBranding(){
  let b=null;
  try{ await DB.open?.(); b = await DB.settings?.get?.('branding'); b = b?.val || b?.value || null; }catch{}
  if(!b) b = readLSBranding() || {};
  applyBranding(b);
}
window.addEventListener('storage', (e)=>{ if(e.key==='branding_touch') loadBranding(); });



/* ===== Helpers ===== */
const SLABS = [5,12,18,28];
const $ = s => document.querySelector(s);
const todayYM = () => new Date().toISOString().slice(0,7);
const ymd = d => new Date(d).toISOString().slice(0,10);

/* ===== Dexie accessors ===== */
async function getAll(table){ try{ await DB.open?.(); return await DB.table(table).toArray(); }catch{ return []; } }

/* Month filter helpers */
function isInMonth(dateStr, ymStr){
  if(!dateStr) return false;
  return dateStr.slice(0,7) === ymStr;
}

/* Build GST lookup from entire purchase history: sku|batch -> gst% */
async function buildGstLookup(){
  const purchases = await getAll('purchases');
  const map = new Map();
  purchases.forEach(p => (p.items||[]).forEach(it=>{
    const sku = it.sku || '';
    const batch = (it.batchNo || it.batch || '').toString().toUpperCase();
    const key = `${sku}|${batch}`;
    const g = Number(it.gst ?? it.taxRate ?? 0);
    if(!map.has(key) && g>0) map.set(key, g);
  }));
  return map;
}

/* Main calculator (DB aligned) */
async function calc(){
  const ym = ($('#month').value || todayYM());
  $('#month').value = ym;

  const [salesAll, purchAll, gstMap] = await Promise.all([
    getAll('sales'), getAll('purchases'), buildGstLookup()
  ]);

  // Filter for the month
  const sales = salesAll.filter(b => isInMonth(b.date, ym));
  const purch = purchAll.filter(b => isInMonth(b.date, ym));

  // Aggregators by slab
  const sAgg = Object.fromEntries(SLABS.map(s=>[s,0]));
  const pAgg = Object.fromEntries(SLABS.map(s=>[s,0]));

  // SALES: use taxable value (rate * qty). Fallback to mrp if rate missing.
  sales.forEach(b => (b.items||[]).forEach(i=>{
    const sku = i.sku || '';
    const batch = (i.batchNo || i.batch || '').toString().toUpperCase();
    const key = `${sku}|${batch}`;
    const slab = Number(i.gst ?? gstMap.get(key) ?? 12); // prefer inline → lookup → 12%
    const qty = Number(i.qty||0);
    const lineBase = Number(i.rate ?? i.mrp ?? 0);
    if(!sAgg.hasOwnProperty(slab)) sAgg[slab]=0;
    sAgg[slab] += qty * lineBase;
  }));

  // PURCHASES: rate * qty under item.gst
  purch.forEach(b => (b.items||[]).forEach(i=>{
    const slab = Number(i.gst ?? i.taxRate ?? 12) || 12;
    const qty = Number(i.qty||0);
    const rate = Number(i.rate||0);
    if(!pAgg.hasOwnProperty(slab)) pAgg[slab]=0;
    pAgg[slab] += qty * rate;
  }));

  // Render table
  const tb = document.querySelector('#gstTable tbody'); tb.innerHTML='';
  let netPay=0, sTot=0, pTot=0;
  SLABS.forEach(s=>{
    const sv = sAgg[s]||0, pv = pAgg[s]||0;
    const diffVal = (sv - pv) * (s/100); // output tax – input tax
    sTot += sv; pTot += pv; netPay += diffVal;
    tb.insertAdjacentHTML('beforeend',
      `<tr><td>${s}%</td><td>${sv.toFixed(2)}</td><td>${pv.toFixed(2)}</td><td>${diffVal.toFixed(2)}</td></tr>`
    );
  });

  $('#netPay').textContent  = netPay.toFixed(2);
  $('#saleTot').textContent = sTot.toFixed(2);
  $('#purchTot').textContent= pTot.toFixed(2);
  $('#gstTot').textContent  = netPay.toFixed(2);
}

/* CSV export */
function exportCSV(){
  const rows=[["GST Slab","Sales","Purchases","Net Diff"]];
  document.querySelectorAll('#gstTable tbody tr').forEach(r=>{
    rows.push(Array.from(r.children).map(td=>td.innerText));
  });
  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="gst_report.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* Wire up */
document.getElementById('btnRefresh').onclick = calc;
document.getElementById('btnCSV').onclick = exportCSV;

/* boot */
calc();
</script>

<!-- engines (outside inline script, correct order) -->
<script src="/scripts/qrcode.min.js?v=1.1"></script>
<script src="/scripts/barcode.js?v=8.4.6"></script>
<script src="/scripts/app-wiring.js?v=1.0"></script>
<script src="/scripts/seed-and-diagnostics.js?v=1.2"></script>

<!-- Pass1 theme + branding hook (non-invasive) -->
<script>
(function(){
  function readBrand(){
    try { return JSON.parse(localStorage.getItem('branding_json')||'null') || null; } catch(e){ return null; }
  }
  const b = readBrand(); if(!b) return;
  const root = document.documentElement;
  const THEMES = {
    pastel: {
      "--bg-gradient":"linear-gradient(145deg,#edf3f0,#ece9f6,#fff0e6)",
      "--card":"#ffffff","--ink":"#0f172a","--muted":"#475569","--primary":"#17B26A",
      "--mint":"#C8E3D2","--lav":"#D7CEF0","--peach":"#FFD8B8"
    },
    glass: {
      "--bg-gradient":"linear-gradient(135deg,#f8fafc,#eef2ff)",
      "--card":"#ffffffcc","--ink":"#0f172a","--muted":"#475569","--primary":"#2563eb",
      "--mint":"#e2e8f0","--lav":"#e9d5ff","--peach":"#ffedd5"
    },
    neo: {
      "--bg-gradient":"linear-gradient(135deg,#f3f4f6,#fafafa)",
      "--card":"#ffffff","--ink":"#111827","--muted":"#6b7280","--primary":"#10b981",
      "--mint":"#d1fae5","--lav":"#ede9fe","--peach":"#ffe4e6"
    },
    iphone: {
      "--bg-gradient":"linear-gradient(180deg,#fdf2f8,#eff6ff)",
      "--card":"#ffffff","--ink":"#0f172a","--muted":"#475569","--primary":"#0ea5e9",
      "--mint":"#e0f2fe","--lav":"#e9d5ff","--peach":"#ffe4e6"
    }
  };
  const theme = THEMES[b.theme || 'pastel'];
  if(theme){
    Object.entries(theme).forEach(([k,v])=> root.style.setProperty(k, v));
  }
  // Swap logos and banners wherever present
  const logoUrl = b.logoUrl || "";
  const banUrl  = b.bannerUrl || "";
  if(logoUrl){
    document.querySelectorAll('img#logo, img#ph_logo, img.logo').forEach(el=> el.src = logoUrl);
  }
  if(banUrl){
    document.querySelectorAll('#hdrBanner, .banner img, img[alt*="Banner"]').forEach(el=> el.src = banUrl);
  }
  // Titles
  if(b.clinicName) { const el=document.getElementById('clinicTitle'); if(el) el.textContent=b.clinicName; }
  if(b.pharmacyName){ const el=document.getElementById('ph_name'); if(el) el.textContent=b.pharmacyName; }
})();
<script src="./scripts/theme-engine.js">
</script>
</body>
</html>