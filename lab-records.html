<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lab Records · Clinic PWA</title>
<link rel="stylesheet" href="./styles.css"/>
<meta name="robots" content="noindex,nofollow"/>
<style>
  :root{
    --bg:#FFF7EF; --ink:#0f172a; --muted:#64748b; --primary:#17B26A;
    --r:16px; --shadow:0 6px 18px rgba(0,0,0,.06);
  }
  body{margin:0;font:14px/1.45 system-ui;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:10px}
  .header{display:flex;align-items:center;gap:10px;background:#DED8F2b3;margin-top:10px;border-radius:12px;padding:10px;box-shadow:var(--shadow)}
  .header .logo{height:36px}
  .btn{background:#fff;color:#111;border:1px solid #cbd5e1;border-radius:20px;padding:8px 14px;font-weight:700;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--primary);color:#fff;border:none}
  .btn.ghost{background:#fff}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
  .card{background:#fff;border-radius:16px;padding:14px;box-shadow:var(--shadow);margin-top:12px}
  .input,select{border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;width:100%}
  .table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
  .table th,.table td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left;vertical-align:top}
  .table th{background:#f1f5f9;position:sticky;top:0;z-index:1}
  .badge{display:inline-block;border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
  .pill{border:1px solid #e5e7eb;background:#F8FAFC;border-radius:999px;padding:4px 8px;font-size:12px}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .sum{font-weight:900}
  .banner{position:relative;overflow:hidden;border-radius:16px;margin:12px 0;background:#D6E5DD}
  .banner img{width:100%;transform:scale(.65);transform-origin:center;opacity:.95;mix-blend-mode:multiply;display:block}
  .nowrap{white-space:nowrap}
  .actions{display:flex;gap:6px;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="header">
    <a class="btn" href="./lab-hub.html">← Back</a>
    <img class="logo" src="./assets/logo.png" alt="">
    <strong>Lab Records</strong>
  </div>

  <!-- Banner (locked style) -->
  <div class="banner"><img src="./assets/banner.png" alt="Lab Banner"></div>

  <!-- Filters / Actions -->
  <div class="card">
    <div class="row">
      <div style="flex:0 0 160px">
        <label>Quick Range</label>
        <select id="range" class="input">
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month" selected>This Month</option>
          <option value="quarter">This Quarter</option>
          <option value="fy">FY (Apr–Mar)</option>
          <option value="all">All</option>
          <option value="custom">Custom…</option>
        </select>
      </div>
      <div style="flex:0 0 160px">
        <label>From</label>
        <input id="from" class="input" type="date">
      </div>
      <div style="flex:0 0 160px">
        <label>To</label>
        <input id="to" class="input" type="date">
      </div>
      <div style="flex:1 1 240px">
        <label>Search (PID / Phone / Name)</label>
        <input id="q" class="input" placeholder="P00123 / 9876… / Kumar">
      </div>
      <div class="actions" style="flex:1 1 220px">
        <button class="btn" id="btnApply">Apply</button>
        <button class="btn" id="btnClear">Clear</button>
        <button class="btn primary" id="btnCSV">Export CSV</button>
      </div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="muted" id="rangeLabel">Range: This Month</div>
      <div class="row">
        <span class="badge" id="count">0 rec</span>
        <span class="badge">Total: <span id="sum" class="sum">₹0</span></span>
      </div>
    </div>

    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>PID</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Tests</th>
          <th class="right">Total (₹)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* ====== Storage & Utils ====== */
const STORE='lab_records_json';
const INR=n=>'₹'+Number(n||0).toFixed(0);
const $=s=>document.querySelector(s);
const todayISO=()=>new Date().toISOString().slice(0,10);
const ymd=d=>new Date(d).toISOString().slice(0,10);
function startOfWeek(d){ d=new Date(d); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return ymd(d); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return ymd(x); }
function firstOfMonth(d){ d=new Date(d); d.setDate(1); return ymd(d); }
function firstOfQuarter(d){ d=new Date(d); const q=Math.floor(d.getMonth()/3)*3; return ymd(new Date(d.getFullYear(), q, 1)); }
function firstOfFY(d){ d=new Date(d); const fyStart=new Date(d.getMonth()>=3?d.getFullYear():d.getFullYear()-1,3,1); return ymd(fyStart); }
function endOfDayISO(d){ const x=new Date(d+'T23:59:59.999Z'); return x.toISOString(); }
function loadAll(){ try{const a=JSON.parse(localStorage.getItem(STORE)||'[]'); return Array.isArray(a)?a:[]}catch{return[]} }

/* Normalize one record from various shapes */
function normalize(rec){
  // date/time
  let ts = rec.ts;
  if(!ts && rec.date){ // saved by lab-tests.html
    ts = new Date(rec.date+'T12:00:00').getTime();
  }
  // tests string
  const testsFromItems = (rec.items||[]).map(x=>x.test||x.name).filter(Boolean);
  const testsFromTests = (rec.tests||[]).map(t=>t.name||t.test).filter(Boolean);
  const tests = (testsFromItems.length?testsFromItems:testsFromTests).join(', ');
  // total
  let total = rec.total;
  if(total==null){
    if(rec.tests && rec.tests.length){ total = rec.tests.reduce((s,t)=>s+(+t.price||0),0); }
    else if(rec.items && rec.items.length){
      // items from PREVIEW don't carry price; keep 0 in that case
      total = 0;
    } else total = 0;
  }
  return {
    id: rec.id || ('LAB'+(ts||Date.now())),
    ts: Number(ts||Date.now()),
    pid: rec.pid||'',
    name: rec.name||'',
    phone: rec.phone||'',
    tests,
    raw: rec,
    total: Number(total||0)
  };
}

/* Printing helper */
async function printRec(rec){
  try{ localStorage.setItem('last_lab_report', JSON.stringify(rec)); }catch{}
  const qs='?data='+encodeURIComponent(JSON.stringify(rec))+'&print=1';
  const target='./print/print-lab.html';
  try{
    const r=await fetch(target,{method:'HEAD',cache:'no-store'});
    if(r.ok){ window.open(target+qs,'_blank'); return; }
  }catch{}
  window.print();
}

/* Date range state */
let gFrom, gTo, ALL=[], FILTERED=[];
function setQuickRange(kind){
  const t=todayISO(); let f=t;
  if(kind==='today'){ f=t; }
  if(kind==='week'){ f=startOfWeek(t); }
  if(kind==='month'){ f=firstOfMonth(t); }
  if(kind==='quarter'){ f=firstOfQuarter(t); }
  if(kind==='fy'){ f=firstOfFY(t); }
  if(kind==='all'){ f='1970-01-01'; }
  gFrom=f; gTo=t;
  $('#from').value=f; $('#to').value=t;
  const txt = kind==='all' ? 'All' : $('#range').selectedOptions[0].text;
  $('#rangeLabel').textContent = 'Range: ' + txt;
}
$('#range').addEventListener('change', ()=>{
  const v=$('#range').value;
  const custom = v==='custom';
  $('#from').disabled=!custom && v!=='all';
  $('#to').disabled=!custom && v!=='all';
  if(!custom) setQuickRange(v);
});

function applyFilters(){
  const q=($('#q').value||'').trim().toLowerCase();
  const from= $('#from').value || '1970-01-01';
  const to  = $('#to').value   || todayISO();
  const t0 = new Date(from+'T00:00:00').getTime();
  const t1 = new Date(to+'T23:59:59').getTime();
  FILTERED = ALL.filter(r=>{
    const inDate = r.ts>=t0 && r.ts<=t1;
    if(!inDate) return false;
    if(!q) return true;
    return (r.pid||'').toLowerCase().includes(q)
        || (r.phone||'').toLowerCase().includes(q)
        || (r.name||'').toLowerCase().includes(q);
  });
  render(FILTERED);
}

/* CSV Export */
function exportCSV(rows){
  const headers=['DateTime','PID','Name','Phone','Tests','Total'];
  const lines=[headers.join(',')];
  rows.forEach(r=>{
    const dt=new Date(r.ts).toLocaleString();
    const vals=[dt,r.pid,r.name,r.phone,r.tests, r.total.toFixed(0)];
    lines.push(vals.map(v=>{
      const s=String(v??'').replace(/"/g,'""');
      return /[",\n]/.test(s)?`"${s}"`:s;
    }).join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lab_records.csv'; a.click(); URL.revokeObjectURL(a.href);
}

/* Render table */
function render(list){
  const tb=$('#tbl tbody'); tb.innerHTML='';
  let sum=0;
  list.sort((a,b)=>b.ts-a.ts).forEach(r=>{
    sum+=Number(r.total||0);
    const dt=new Date(r.ts).toLocaleString();
    const payload=encodeURIComponent(JSON.stringify(r.raw||{}));
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${dt}</td>
      <td>${r.pid||''}</td>
      <td>${r.name||''}</td>
      <td>${r.phone||''}</td>
      <td>${r.tests||''}</td>
      <td class="right">${(r.total||0).toFixed(0)}</td>
      <td class="nowrap">
        <button class="btn" onclick='printRec(JSON.parse(decodeURIComponent("${payload}")))'>Print</button>
      </td>
    `;
    tb.appendChild(tr);
  });
  $('#count').textContent = `${list.length} rec`;
  $('#sum').textContent = INR(sum);
}

/* Boot */
document.addEventListener('DOMContentLoaded', ()=>{
  // load & normalize
  ALL = loadAll().map(normalize);
  // default range
  setQuickRange('month');
  $('#btnApply').onclick=applyFilters;
  $('#btnClear').onclick=()=>{ $('#q').value=''; setQuickRange('month'); applyFilters(); };
  $('#btnCSV').onclick=()=> exportCSV(FILTERED.length?FILTERED:ALL);
  // if custom is selected, allow manual dates and apply on change
  $('#from').addEventListener('change', ()=>{ if($('#range').value==='custom') applyFilters(); });
  $('#to').addEventListener('change', ()=>{ if($('#range').value==='custom') applyFilters(); });
  $('#q').addEventListener('input', ()=> applyFilters());

  applyFilters();
});
</script>
</body>
</html>