<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Settings (Admin) · Clinic PWA</title>

  <!-- Existing project deps -->
  <link rel="manifest" href="./manifest.json"/>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./config/config.js"></script>
  <script src="./scripts/db.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>

  <style>
    :root{
      --bg-gradient:linear-gradient(145deg,#edf3f0,#ece9f6,#fff0e6);
      --mint:#C8E3D2; --lav:#D7CEF0; --peach:#FFD8B8;
      --card:#ffffff; --ink:#0f172a; --muted:#475569; --primary:#17B26A;
      --r:16px; --shadow:0 6px 18px rgba(0,0,0,0.06);

      /* Banner live vars (controlled by UI) */
      --banner-h: 160px;           /* height */
      --banner-fit: contain;       /* contain | cover */
      --banner-bg: var(--lav);     /* container tint */
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui;background:var(--bg-gradient);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:0 10px}

    .header{display:flex;align-items:center;justify-content:space-between;
      padding:10px 14px;background:var(--mint);border:1px solid #0001;border-radius:12px;
      box-shadow:var(--shadow);margin-top:10px}
    .header .logo{height:40px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .card{border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:12px;background:var(--card)}

    .btn{background:#fff;border:1px solid #cbd5e1;border-radius:20px;padding:6px 14px;font-weight:600;cursor:pointer}
    .btn:hover{background:#f1f5f9}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .input,select,textarea{border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;width:100%}
    .badge{display:inline-block;background:#fff;border:1px solid #e2e8f0;border-radius:999px;padding:3px 10px;font-size:12px;font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .footer{text-align:center;padding:14px 4px;font-size:13px;color:var(--muted);margin:18px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left;font-size:13px}
    th{background:#f1f5f9}

    /* Banner that is controlled by settings */
    .banner{
      overflow:hidden;border-radius:var(--r);margin:10px 0;background:var(--banner-bg);
      height:var(--banner-h);display:flex;align-items:center;justify-content:center
    }
    .banner img{
      display:block;max-height:calc(var(--banner-h) - 12px);width:100%;
      object-fit:var(--banner-fit);object-position:center;
      mix-blend-mode:multiply;opacity:.95;border-radius:var(--r)
    }

    .alert{margin-top:8px;padding:8px 10px;border-radius:8px;background:#dcfce7;color:#065f46;display:none}
    .warn{background:#FEF3C7;color:#92400E}

    /* Branding previews */
    .previewWrap{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .previewTile{border:1px solid #e5e7eb;border-radius:12px;padding:8px;box-shadow:var(--shadow);background:#fff}
    .previewTile img{display:block;max-height:80px;max-width:220px;object-fit:contain}
    .hint{font-size:12px;color:#64748b}

    /* Range control layout */
    .rangeRow{display:flex;gap:10px;align-items:center}
    .rangeRow input[type="range"]{flex:1}
    .klabel{min-width:120px;color:#64748b;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="header">
    <div class="row">
      <img id="hdrLogo" class="logo" src="./assets/logo.png" alt="logo">
      <div>
        <div style="font-weight:700;font-size:18px">Settings / Admin</div>
        <div class="small">Branding · Navigation · Backup & Seed</div>
      </div>
    </div>
    <a class="btn" href="./index.html">Home</a>
  </div>

  <!-- Live banner (reads current vars) -->
  <div class="banner">
    <img id="hdrBanner" src="./assets/banner.png" alt="Clinic Banner">
  </div>

  <!-- Navigation quick links (unchanged) -->
  <div class="card" style="background:var(--mint)">
    <h3>Navigation</h3>
    <div class="row">
      <a class="btn" href="./bookings.html">Bookings</a>
      <a class="btn" href="./opd-live.html">OPD</a>
      <a class="btn" href="./lab-hub.html">Lab</a>
      <a class="btn" href="./tv.html">TV</a>
      <a class="btn" href="./pharmacy.html"><span id="phNavName">Pharmacy</span></a>
      <a class="btn" href="./inventory.html">Inventory</a>
      <a class="btn" href="./sales.html">Sales (POS)</a>
      <a class="btn" href="./purchases.html">Purchases</a>
      <a class="btn" href="./returns.html">Returns</a>
      <a class="btn primary" href="./test.html">Open Test Suite</a>
    </div>
  </div>

  <!-- BRANDING CONTROL CENTER -->
  <div class="card" style="background:var(--peach)">
    <h3>Branding & Theme (controls everything)</h3>
    <div class="small" style="margin-bottom:6px">
      This branding applies across all pages. Save to persist. Other tabs update instantly.
    </div>

    <!-- Text/labels -->
    <div class="row">
      <div style="flex:1 1 240px">
        <label>Clinic Name</label>
        <input id="bClinicName" class="input" placeholder="Your Clinic / Hospital">
      </div>
      <div style="flex:1 1 240px">
        <label>Clinic Tagline</label>
        <input id="bClinicTag" class="input" placeholder="Care you can trust">
      </div>
      <div style="flex:1 1 240px">
        <label>Pharmacy Name</label>
        <input id="bPhName" class="input" placeholder="(Shown on Pharmacy Hub)">
      </div>
      <div style="flex:1 1 240px">
        <label>Pharmacy Tagline</label>
        <input id="bPhTag" class="input" placeholder="Fast · Genuine · Affordable">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="flex:1 1 480px">
        <label>Address (multi-line)</label>
        <textarea id="bAddress" class="input" rows="2" placeholder="Street, Area, City · Phone · GSTIN"></textarea>
      </div>
      <div style="flex:0 0 220px">
        <label>Theme <small class="small">(live preview)</small></label>
        <select id="bTheme" class="input">
          <option value="pastel">Pastel (default)</option>
          <option value="glass">Glass</option>
          <option value="neo">Neo</option>
          <option value="iphone">iPhone</option>
        </select>
      </div>
    </div>

    <!-- Logo / Banner -->
    <div class="row" style="margin-top:8px;align-items:flex-end">
      <div style="flex:1 1 260px">
        <label>Logo (PNG/JPG)</label>
        <input id="bLogo" class="input" type="file" accept="image/*">
      </div>
      <div style="flex:1 1 260px">
        <label>Banner (PNG/JPG)</label>
        <input id="bBanner" class="input" type="file" accept="image/*">
      </div>
      <div class="row" style="flex:1">
        <button class="btn" id="btnBrandReset">Reset</button>
        <button class="btn primary" id="btnBrandSave">Save Branding</button>
      </div>
    </div>

    <!-- Banner sizing controls -->
    <div class="row" style="margin-top:8px">
      <div style="flex:0 0 220px">
        <label>Banner Fit</label>
        <select id="bBannerFit" class="input" title="contain shows full image; cover fills edge-to-edge">
          <option value="contain">Auto-fit (contain)</option>
          <option value="cover">Edge-to-edge (cover)</option>
        </select>
      </div>
      <div style="flex:1">
        <label>Banner Height</label>
        <div class="rangeRow">
          <span class="klabel">Compact</span>
          <input id="bBannerH" type="range" min="100" max="280" step="10" value="160">
          <span class="klabel">Large</span>
          <span id="bBannerHVal" class="badge">160px</span>
        </div>
      </div>
    </div>

    <!-- Previews -->
    <div class="previewWrap">
      <div class="previewTile">
        <div class="small">Logo preview</div>
        <img id="pvLogo" src="./assets/logo.png" alt="logo preview">
      </div>
      <div class="previewTile">
        <div class="small">Banner preview</div>
        <img id="pvBanner" src="./assets/banner.png" alt="banner preview" style="max-width:420px">
      </div>
    </div>
    <div class="hint" style="margin-top:6px">Tip: Keep logo wide (transparent). Choose “Auto-fit” to see full banner, or “Cover” to fill edge-to-edge.</div>
    <div id="msgBR" class="alert" style="display:none"></div>
  </div>

  <!-- Owner Contact (unchanged) -->
  <div class="card" style="background:var(--lav)">
    <h3>Owner Contact</h3>
    <div class="small" style="margin-bottom:6px">Used by Analytics → “Share Summary (WhatsApp)”. Store a 10-digit mobile number.</div>
    <div class="row" style="align-items:end">
      <div style="flex:0 0 240px">
        <label>Owner phone (10 digits)</label>
        <input id="ownerPhone" class="input" placeholder="9xxxxxxxxx">
      </div>
      <button class="btn primary" id="btnSaveOwner">Save</button>
      <span class="badge" id="ownerSaved">—</span>
    </div>
  </div>

  <!-- Backups / Snapshots / PINs / Diagnostics -->
  <!-- (kept same as your existing; omitted here for brevity of UI preview) -->
  <div class="card" style="background:var(--mint)">
    <h3>Seed & Diagnostics</h3>
    <div class="row" style="gap:8px">
      <button class="btn" onclick="toggleDiag()">Toggle Diagnostics</button>
      <button class="btn" onclick="reSeed()">Re-seed Demo Data</button>
      <button class="btn" onclick="clearSeed()">Clear Seed Flag</button>
      <button class="btn" onclick="wipeAll()">Wipe All Local Data</button>
    </div>
  </div>

  <div class="footer">© 2025 <strong>Powered by Onestop AI Services</strong> · All Rights Reserved</div>
</div>

<script>
/* ---------- Toast ---------- */
const toast = (id, text, type='ok')=>{
  const el=document.getElementById(id); if(!el) return;
  el.textContent=text;
  el.className='alert'+(type==='warn'?' warn':'' );
  el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 2200);
};

/* ---------- DB handle (robust to existing db.js) ---------- */
(function ensureDB(){
  if(window.DB) return;
  try{
    const db = new Dexie('onesystem_clinic');
    db.version(1).stores({ settings:'key' });
    window.DB = db;
  }catch(e){ console.warn('DB fallback failed', e); }
})();

/* ---------- Themes (live preview only) ---------- */
const THEMES = {
  pastel: {
    '--bg-gradient':'linear-gradient(145deg,#edf3f0,#ece9f6,#fff0e6)',
    '--mint':'#C8E3D2','--lav':'#D7CEF0','--peach':'#FFD8B8',
    '--card':'#ffffff','--ink':'#0f172a','--muted':'#475569','--primary':'#17B26A'
  },
  glass: {
    '--bg-gradient':'linear-gradient(135deg,#eef2ff,#ecfeff,#fef9c3)',
    '--mint':'#E0F2FE','--lav':'#E9D5FF','--peach':'#FFE4E6',
    '--card':'#ffffff','--ink':'#0f172a','--muted':'#475569','--primary':'#0EA5E9'
  },
  neo: {
    '--bg-gradient':'linear-gradient(145deg,#f1f5f9,#e2e8f0,#f8fafc)',
    '--mint':'#E2F7EC','--lav':'#EDE9FE','--peach':'#FFEAD5',
    '--card':'#ffffff','--ink':'#0f172a','--muted':'#475569','--primary':'#111827'
  },
  iphone: {
    '--bg-gradient':'linear-gradient(180deg,#f7f7f7,#f0f0f0)',
    '--mint':'#E6F4EA','--lav':'#EEE7FF','--peach':'#FFE7D6',
    '--card':'#ffffff','--ink':'#111111','--muted':'#4b5563','--primary':'#0A84FF'
  }
};
function applyTheme(name){
  const m = THEMES[name] || THEMES.pastel;
  const root = document.documentElement;
  Object.entries(m).forEach(([k,v])=> root.style.setProperty(k,v));
}

/* ---------- Helpers ---------- */
const $ = (s)=>document.querySelector(s);
const readLSBranding = ()=>{ try{ return JSON.parse(localStorage.getItem('branding_json')||'null')||null; }catch{ return null; } };
const writeLSBranding = (obj)=> localStorage.setItem('branding_json', JSON.stringify(obj));
const fileToDataURL = (file)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });

/* ---------- Broadcast branding changes to other tabs/pages ---------- */
function broadcastBrandingTouch(){
  try{ localStorage.setItem('branding_touch', String(Date.now())); }catch{}
}

/* ---------- Load branding ---------- */
async function loadBranding(){
  let b=null;
  try{ await DB.open?.(); b = await DB.settings?.get?.('branding'); b = b?.val || b?.value || null; }catch(e){ console.warn(e); }
  if(!b) b = readLSBranding();

  // Defaults
  b = b || {
    clinicName:'', clinicTag:'', address:'',
    pharmacyName:'', pharmacyTag:'', theme:'pastel',
    logoUrl:'', bannerUrl:'',
    bannerFit:'contain', bannerH:160
  };

  // Form
  $('#bClinicName').value = b.clinicName||'';
  $('#bClinicTag').value  = b.clinicTag||'';
  $('#bPhName').value     = b.pharmacyName||'';
  $('#bPhTag').value      = b.pharmacyTag||'';
  $('#bAddress').value    = b.address||'';
  $('#bTheme').value      = b.theme||'pastel';
  $('#bBannerFit').value  = b.bannerFit||'contain';
  $('#bBannerH').value    = Number(b.bannerH||160);
  $('#bBannerHVal').textContent = `${$('#bBannerH').value}px`;

  // Theme live
  applyTheme(b.theme||'pastel');

  // Preview + header banner
  const logo = b.logoUrl || './assets/logo.png';
  const banner = b.bannerUrl || './assets/banner.png';
  $('#pvLogo').src = logo; $('#pvBanner').src = banner;
  $('#hdrLogo').src = logo; $('#hdrBanner').src = banner;

  // Apply banner CSS vars
  document.documentElement.style.setProperty('--banner-h', `${b.bannerH||160}px`);
  document.documentElement.style.setProperty('--banner-fit', b.bannerFit||'contain');

  // Nav label
  $('#phNavName').textContent = b.pharmacyName || 'Pharmacy';
}

/* ---------- Save branding ---------- */
$('#btnBrandSave').onclick = async ()=>{
  const obj = {
    clinicName:   $('#bClinicName').value.trim(),
    clinicTag:    $('#bClinicTag').value.trim(),
    pharmacyName: $('#bPhName').value.trim(),
    pharmacyTag:  $('#bPhTag').value.trim(),
    address:      $('#bAddress').value.trim(),
    theme:        $('#bTheme').value,
    logoUrl:      $('#pvLogo').src,
    bannerUrl:    $('#pvBanner').src,
    bannerFit:    $('#bBannerFit').value,
    bannerH:      Number($('#bBannerH').value||160)
  };

  const fLogo = $('#bLogo').files[0];
  const fBan  = $('#bBanner').files[0];
  try{
    if(fLogo) obj.logoUrl = await fileToDataURL(fLogo);
    if(fBan)  obj.bannerUrl = await fileToDataURL(fBan);
  }catch(e){ console.warn(e); }

  try{
    await DB.open?.();
    await DB.settings?.put?.({key:'branding', val:obj});
  }catch(e){ console.warn('DB.settings.put branding failed; LS fallback still works'); }
  writeLSBranding(obj);

  // Apply instantly
  applyTheme(obj.theme);
  $('#pvLogo').src = obj.logoUrl || './assets/logo.png';
  $('#pvBanner').src = obj.bannerUrl || './assets/banner.png';
  $('#hdrLogo').src = obj.logoUrl || './assets/logo.png';
  $('#hdrBanner').src = obj.bannerUrl || './assets/banner.png';
  document.documentElement.style.setProperty('--banner-h', `${obj.bannerH}px`);
  document.documentElement.style.setProperty('--banner-fit', obj.bannerFit);
  $('#phNavName').textContent = obj.pharmacyName || 'Pharmacy';

  broadcastBrandingTouch();
  toast('msgBR','Branding saved');
};

/* ---------- Reset branding ---------- */
$('#btnBrandReset').onclick = async ()=>{
  $('#bClinicName').value=''; $('#bClinicTag').value='';
  $('#bPhName').value='';     $('#bPhTag').value='';
  $('#bAddress').value='';
  $('#bTheme').value='pastel';
  $('#bBannerFit').value='contain';
  $('#bBannerH').value=160; $('#bBannerHVal').textContent='160px';

  applyTheme('pastel');
  $('#pvLogo').src='./assets/logo.png';
  $('#pvBanner').src='./assets/banner.png';
  $('#hdrLogo').src='./assets/logo.png';
  $('#hdrBanner').src='./assets/banner.png';

  try{ await DB.settings?.delete?.('branding'); }catch{}
  localStorage.removeItem('branding_json');

  document.documentElement.style.setProperty('--banner-h', '160px');
  document.documentElement.style.setProperty('--banner-fit','contain');

  $('#phNavName').textContent='Pharmacy';
  broadcastBrandingTouch();
  toast('msgBR','Branding reset');
};

/* ---------- Live controls (no save yet) ---------- */
$('#bTheme').addEventListener('change', e=> applyTheme(e.target.value));
$('#bBannerFit').addEventListener('change', e=>{
  document.documentElement.style.setProperty('--banner-fit', e.target.value);
});
$('#bBannerH').addEventListener('input', e=>{
  const v = Number(e.target.value||160);
  $('#bBannerHVal').textContent = `${v}px`;
  document.documentElement.style.setProperty('--banner-h', `${v}px`);
});

/* ---------- Owner phone ---------- */
$('#btnSaveOwner').onclick = async ()=>{
  const raw = ($('#ownerPhone').value||'').replace(/\D/g,'');
  if(!/^\d{10}$/.test(raw)){ $('#ownerSaved').textContent='Invalid number'; return; }
  try{
    await DB.open?.(); await DB.settings?.put?.({key:'owner_phone', val:raw});
    $('#ownerSaved').textContent = 'Saved: '+raw;
  }catch{ $('#ownerSaved').textContent='Save failed'; }
};

/* ---------- Diagnostics & Seed stubs ---------- */
function toggleDiag(){
  if(!window.DB || !DB.enableDiagnostics){ toast('msgBR','DB not loaded','warn'); return; }
  window._diagEnabled = !window._diagEnabled;
  DB.enableDiagnostics(window._diagEnabled);
  toast('msgBR','Diagnostics: '+(window._diagEnabled?'ON':'OFF'));
}
function reSeed(){ localStorage.removeItem('clinic_seed_v1'); toast('msgBR','Seed flag cleared. Reloading…'); setTimeout(()=>location.reload(),400); }
function clearSeed(){ localStorage.removeItem('clinic_seed_v1'); toast('msgBR','Seed flag cleared (no reload).'); }
async function wipeAll(){
  if(!confirm('This will erase all local data. Continue?')) return;
  await Dexie.delete('onesystem_clinic').catch(()=>{});
  localStorage.clear();
  toast('msgBR','All local data wiped. Reloading…'); setTimeout(()=>location.reload(),600);
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', loadBranding);
</script>

<!-- Engines (keep) -->
<script src="/scripts/qrcode.min.js?v=1.1"></script>
<script src="/scripts/barcode.js?v=8.4.6"></script>
<script src="/scripts/app-wiring.js?v=1.1"></script>
<script src="/scripts/seed-and-diagnostics.js?v=1.2"></script>
</body>
</html>