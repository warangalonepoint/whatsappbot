<!doctype html>
<html lang="en">
<head>
<script src="./config/config.js"></script>
<script src="./scripts/db.js"></script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OPD Records · Clinic PWA</title>
<link rel="manifest" href="./manifest.json"/>
<link rel="stylesheet" href="./styles.css"/>
<script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>
<script src="./scripts/db.js"></script>
<style>
:root{--bg:linear-gradient(145deg,#f4f8f6,#f3f0fa,#fff4ec);--card:#fff;--ink:#0f172a;--muted:#475569;--primary:#17B26A;--r:16px;--shadow:0 6px 18px rgba(0,0,0,.06);--banner-bg:#f5f3ff;--banner-line:#e5e7eb}
*{box-sizing:border-box}
body{margin:0;font:14px/1.45 system-ui;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:0 10px}
.topbar{margin-top:10px;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);background:var(--banner-bg);border:1px solid var(--banner-line)}
.topbar .row{display:flex;align-items:center;gap:12px;padding:10px 12px}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:40px}
.brand .title{font-weight:800;font-size:18px}
.brand .sub{font-size:12px;color:var(--muted)}
.links{margin-left:auto;display:flex;gap:8px}
.btn{background:#fff;border:1px solid #cbd5e1;border-radius:20px;padding:6px 14px;font-weight:600;cursor:pointer;text-decoration:none;color:inherit;display:inline-block}
.card{background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:12px}
.row{display:flex;flex-wrap:wrap;gap:10px}
.input{border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;width:100%}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left}
.table th{background:#f1f5f9}
.badge{display:inline-block;border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
.footer{text-align:center;padding:14px 4px;font-size:13px;color:var(--muted);margin:18px 0}

/* Banner (locked style) */
.banner{position:relative;overflow:hidden;border-radius:16px;margin:12px 0;background:#D6E5DD}
.banner img{width:100%;transform:scale(.65);transform-origin:center;opacity:.95;mix-blend-mode:multiply;display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <img id="logoImg" src="./assets/logo.png" alt="logo">
        <div>
          <div class="title" id="pageTitle">OPD Records</div>
          <div class="sub" id="pageSub">Search · Print · CSV export</div>
        </div>
      </div>
      <div class="links">
        <a class="btn" href="./index.html">Home</a>
        <a class="btn" id="linkOpd" href="./opd.html">OPD Live</a>
        <a class="btn" href="./bookings.html">Bookings</a>
      </div>
    </div>
  </div>

  <div class="banner"><img id="bannerImg" src="./assets/banner.png" alt="Clinic Banner"></div>

  <div class="card" style="background:#E8F6ED">
    <div class="row" style="align-items:end">
      <div style="flex:1 1 260px">
        <label>Search by PID or Phone</label>
        <input id="q" class="input" placeholder="P00123 or 10-digit phone">
      </div>
      <div style="flex:0 0 140px"><button class="btn" id="btnSearch">Search</button></div>
      <div style="flex:0 0 120px"><button class="btn" id="btnClear">Clear</button></div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <div class="badge" id="total">Total: 0</div>
        <button class="btn" id="btnCSV">Export CSV</button>
      </div>
    </div>
  </div>

  <div class="card" style="background:#FFF8F0">
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Date/Time</th><th>PID</th><th>Name</th><th>Phone</th>
          <th>Complaints</th><th>Diagnosis</th><th>BMI</th><th>Next Visit</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">© 2025 <strong>Powered by Onestop AI Services</strong> · All Rights Reserved</div>
</div>

<script>
const $=s=>document.querySelector(s);
let ALL=[], ENRICHED=[];

/* ---- Brand apply from ./config/doctor-config.json + UI overrides (optional) ---- */
(async function brandApply(){
  try{
    const r = await fetch('./config/doctor-config.json',{cache:'no-store'});
    if(r.ok){
      const c = await r.json();
      if(c.clinicName) $('#pageTitle').textContent = 'OPD Records · ' + c.clinicName;
      const line = [c.doctorName,c.degrees,c.addressLine1,c.phone].filter(Boolean).join(' · ');
      if(line) $('#pageSub').textContent = line;
    }
  }catch{}
  try{
    const u = JSON.parse(localStorage.getItem('onesystem.ui_overrides')||'null')||{};
    if(u.brandColor) document.documentElement.style.setProperty('--primary', u.brandColor);
    if(u.logoDataUrl) $('#logoImg').src = u.logoDataUrl;
    if(u.bannerDataUrl) $('#bannerImg').src = u.bannerDataUrl;
  }catch{}
})();

/* ---- OPD Live link resolver (supports ./opd.html OR ./opd-live.html) ---- */
(async function resolveOpdLink(){
  const candidates = ['./opd.html','./opd-live.html'];
  for (const p of candidates){
    try{ const resp = await fetch(p,{method:'HEAD',cache:'no-store'}); if(resp.ok){ $('#linkOpd').href = p; break; } }catch{}
  }
})();

/* ---- Dexie helpers ---- */
async function dexieOpen(){
  const db=new Dexie('clinicdb');
  try{ db.version(1).stores({patients:'pid,patientName,contact',opd:'++id,ts,pid'}); await db.open(); }catch{}
  return db;
}
async function phoneByPID(pid){
  try{
    if (window.DB?.findPatientByPID){
      const p=await DB.findPatientByPID(pid).catch(()=>null);
      return p?.contact||"";
    }
    const db=await dexieOpen();
    const p=await db.table('patients').get(pid) || await db.table('patients').where('pid').equals(pid).first();
    db.close();
    return p?.contact||"";
  }catch{return "";}
}

/* ---- Load Records ---- */
async function loadAll(){
  try{
    if (window.DB?.listOPD){
      ALL = await DB.listOPD();
    }else{
      const db=await dexieOpen();
      ALL = await db.table('opd').toArray();
      db.close();
      try{ const ls=JSON.parse(localStorage.getItem('opd_local_json')||'[]'); ALL=ALL.concat(ls); }catch{}
    }
  }catch{ ALL=[]; }

  ALL = (ALL||[]).map(r=>({
    ts: r.ts, pid:r.pid, name:r.name||'', phone:r.phone||'',
    height: r.vitals?.height||r.height, weight:r.vitals?.weight||r.weight, temp:r.vitals?.temp||r.temp,
    complaints: r.notes?.cc ?? r.complaints ?? '',
    diagnosis:  r.notes?.dx ?? r.diagnosis ?? '',
    nextVisit:  r.nextVisit || r.nextVisitDate || ''
  })).sort((a,b)=>(b.ts||0)-(a.ts||0));

  const map=new Map();
  await Promise.all(ALL.map(async r=>{ if(!r.phone && !map.has(r.pid)) map.set(r.pid, await phoneByPID(r.pid)); }));
  ENRICHED = ALL.map(r=>({...r, phone: r.phone || map.get(r.pid) || ""}));
  $("#total").textContent = "Total: "+ENRICHED.length;
}

function bmi(h,w){h=+h||0;w=+w||0;const m=h?h/100:0;const v=(m>0&&w>0)?(w/(m*m)):0;return v?v.toFixed(2):"";}

/* ---- Render ---- */
function render(list=ENRICHED){
  const tb=$("#tbl tbody"); tb.innerHTML="";
  list.forEach(r=>{
    const dt=new Date(r.ts||Date.now()).toLocaleString();
    const payload=encodeURIComponent(JSON.stringify(r));
    tb.insertAdjacentHTML("beforeend",
      `<tr>
        <td>${dt}</td>
        <td><a href="#" data-pid="${r.pid}" class="opdLink">${r.pid||""}</a></td>
        <td>${r.name||""}</td>
        <td>${r.phone||""}</td>
        <td>${r.complaints||""}</td>
        <td>${r.diagnosis||""}</td>
        <td>${bmi(r.height,r.weight)}</td>
        <td>${r.nextVisit||""}</td>
        <td>
          <button class="btn" onclick='printRec(JSON.parse(decodeURIComponent("${payload}")))'>Print</button>
        </td>
      </tr>`
    );
  });

  // wire PID → OPD (works with whichever file exists)
  document.querySelectorAll('.opdLink').forEach(a=>{
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      const pid = a.dataset.pid;
      const candidates = ['./opd.html','./opd-live.html'];
      let target = null;
      for (const p of candidates){
        try{ const resp=await fetch(p,{method:'HEAD',cache:'no-store'}); if(resp.ok){ target=p; break; } }catch{}
      }
      if(!target){ alert('OPD page not found (opd.html or opd-live.html)'); return; }
      window.location.href = `${target}?pid=${encodeURIComponent(pid)}`;
    });
  });
}

/* ---- Search / CSV ---- */
$("#btnSearch").onclick=()=>{
  const q=$("#q").value.trim().toUpperCase();
  if(!q) return render();
  const byPid = ENRICHED.filter(r=>(r.pid||"").toUpperCase().includes(q));
  const byPhone = ENRICHED.filter(r=>(r.phone||"").includes(q));
  const ids=new Set(); const out=[];
  [...byPid,...byPhone].forEach(r=>{const k=r.pid+"_"+r.ts; if(!ids.has(k)){ids.add(k); out.push(r);} });
  render(out);
};
$("#btnClear").onclick=()=>{ $("#q").value=""; render(); };

$("#btnCSV").onclick=()=>{
  const rows=[["DateTime","PID","Name","Phone","Complaints","Diagnosis","BMI","NextVisit"]];
  ENRICHED.forEach(r=>rows.push([
    new Date(r.ts||Date.now()).toLocaleString(), r.pid||"", r.name||"", r.phone||"",
    r.complaints||"", r.diagnosis||"", bmi(r.height,r.weight), r.nextVisit||""
  ]));
  const csv=rows.map(a=>a.map(x=>String(x).replaceAll('"','""')).map(x=>`"${x}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="opd-records.csv"; a.click(); URL.revokeObjectURL(a.href);
};

/* ---- Print (robust) ---- */
window.printRec = async (r)=>{
  // stash for printers that read from storage
  try{ localStorage.setItem('opd_print_payload', JSON.stringify(r)); }catch{}
  const qs = '?data=' + encodeURIComponent(JSON.stringify(r)) + '&print=1';
  const paths = ['./print-opd.html', './print/print-opd.html'];
  let target = null;
  for (const p of paths) {
    try { const resp = await fetch(p, { method:'HEAD', cache:'no-store' }); if (resp.ok) { target = p; break; } }
    catch(_) {}
  }
  if (!target) { alert('print-opd.html not found.\nPlace it next to opd-records.html or in ./print/'); return; }
  window.open(target + qs, '_blank');
};

/* ---- Go ---- */
(async function init(){ await loadAll(); render(); })();
<script src="./scripts/theme-engine.js">
</script>
</body>
</html>